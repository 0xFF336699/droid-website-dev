{"version":3,"file":"static/chunks/pages/im/room-b1127864db6c3648.js","mappings":"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","sources":["webpack://_N_E/../../node_modules/.pnpm/react-i18next@15.6.0_i18next@24.2.3_typescript@5.7.3__react-dom@19.1.0_react@19.1.0__react@19.1.0_typescript@5.7.3/node_modules/react-i18next/dist/es/index.js","webpack://_N_E/../../../src/watcher/useWatchUpdates.tsx","webpack://_N_E/../../../../src/components/page/PageContent.tsx","webpack://_N_E/../../../../src/components/page/AndroidPageContent.tsx","webpack://_N_E/../../../../src/components/app/AppShell.tsx","webpack://_N_E/./src/im/components/meeting/MeetingCreateDialog.tsx","webpack://_N_E/./src/im/element-call/meetingEvent.ts","webpack://_N_E/./src/im/components/room/HeaderExtraButton.tsx","webpack://_N_E/./src/im/components/room/RoomHeader.tsx","webpack://_N_E/./src/im/components/messages/text/TextMessage.tsx","webpack://_N_E/./src/im/components/messages/location/LocationMessage.tsx","webpack://_N_E/./src/im/components/messages/invite/InviteMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomNameMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomHistoryVisibilityMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomJoinRuleMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomPowerLevelsMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomGuestAccessMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomTopicMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomCreateMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomAvatarMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomCanonicalAliasMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomTombstoneMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomEncryptionMessage.tsx","webpack://_N_E/./src/im/components/messages/room/RoomServerAclMessage.tsx","webpack://_N_E/./src/im/components/messages/MessageRenderer.tsx","webpack://_N_E/./src/im/components/room/MessageItem.tsx","webpack://_N_E/./src/im/components/room/MessageList.tsx","webpack://_N_E/./src/im/client/message/handlers/location.ts","webpack://_N_E/../../../src/map/map.intf.ts","webpack://_N_E/../../../src/map/MapView.tsx","webpack://_N_E/./src/im/components/messages/location/LocationPicker.tsx","webpack://_N_E/./src/im/components/room/MessageInput.tsx","webpack://_N_E/./src/im/components/room/MessageListScroller.tsx","webpack://_N_E/./src/im/components/room/RoomContent.tsx","webpack://_N_E/./src/im/components/room/RoomMembers.tsx","webpack://_N_E/./src/im/components/room/index.ts","webpack://_N_E/./src/im/client/message/handlers/loadHistory.ts","webpack://_N_E/./src/im/components/room/MessageListVirtuoso.tsx","webpack://_N_E/./src/im/components/meeting/MeetingPanel.tsx","webpack://_N_E/./src/im/components/room/RoomContent2.tsx","webpack://_N_E/./src/pages/im/room/index.tsx","webpack://_N_E/?bd42","webpack://_N_E/../../../src/watcher/useProxyWatch.ts","webpack://_N_E/../../../src/mc/static-model.ts","webpack://_N_E/../../../../src/components/motion/page-transition.tsx","webpack://_N_E/../../../../src/components/app/PageShell.tsx","webpack://_N_E/../../../../src/components/appbar/AppBar.tsx"],"sourcesContent":["export * from \"C:\\\\work\\\\android-droid\\\\html\\\\website-2024-12\\\\node_modules\\\\.pnpm\\\\react-i18next@15.6.0_i18next@24.2.3_typescript@5.7.3__react-dom@19.1.0_react@19.1.0__react@19.1.0_typescript@5.7.3\\\\node_modules\\\\react-i18next\\\\dist\\\\es\\\\index.js\"","import _ from \"lodash\"\r\nimport { useEffect, useState } from \"react\"\r\nimport { IWatchUpdatesConfig, watchUpdates } from \"./watchUpdates\"\r\nimport { PropertiesChain, toProxy } from \"./proxyWatch\"\r\nimport { useProxyWatch } from \"./useProxyWatch\"\r\nimport { objectCountUtils } from \"../utils\"\r\nimport { useWatch } from \"./UseWatch\"\r\nimport { Log } from \"../log\"\r\n\r\n/**\r\n * \r\n * 注意，返回的无论是object还是array，都无法监听，因为它们不是proxy，而是原始对象的副本\r\n * @param target 要监听的对象\r\n * @param conf 监听配置\r\n * @returns 监听的对象\r\n */\r\nexport function useWatchUpdates<T extends object>(target: T, conf?: IWatchUpdatesConfig<T>): [T] {\r\n    const [value, setValue] = useState<T>(target)\r\n    useEffect(() => {\r\n        console.log('use watch updates look look id', objectCountUtils.getObjectCount(target))\r\n        watchUpdates(target, (info) => {\r\n            console.log('uuuuuuuuuupdated', info)\r\n            console.log('tttttttarget=', target);\r\n            const now = _.isArray(info.target) ? [...info.target] : info.target\r\n            // setValue(now as T)\r\n            setValue((_.isArray(target) ? [...target] : { ...target }) as T)\r\n        }, conf)\r\n    }, [])\r\n    return [value as T]\r\n}\r\n\r\n/**\r\n * useProxyWatch + useWatchUpdates 结合体\r\n * 因为react的刷新机制，所以第二个state必须得用setState才会生效。\r\n * 不然其实这是两行代码，第一行是useProxyWatch，第二行是useWatchUpdates就可以了。\r\n * @param target 要监听的对象\r\n * @param propertyChain 要监听的属性链\r\n * @param defaultValue 默认值\r\n * @param conf 监听配置\r\n * @returns 监听的对象 返回的第一个参数是重新拼装的{...arr} or {...obj}，第二个参数是原始的target or defaultValue\r\n */\r\nexport function useProxyWatchUpdates<T extends object, U extends object>(target: T,\r\n    propertyChain: PropertiesChain<T>,\r\n    defaultValue: U,\r\n    conf?: IWatchUpdatesConfig<U>): [U, U] {\r\n        const logger = new Log(false, 'useProxyWatchUpdates_fn');\r\n        logger.pause = true;\r\n    const [v] = useProxyWatch(target, propertyChain, defaultValue)\r\n    const [value, setValue] = useState<U>(v);\r\n    logger.log(`propertyChain=`, propertyChain);\r\n    logger.log(`value=`, value);\r\n    logger.log('v=', v);\r\n    logger.log('defaultValue=', defaultValue)\r\n    useEffect(() => {\r\n        logger.log(`useEffect_fn v=`, v)\r\n        const newValue = _.isArray(v)\r\n            ? [...v]\r\n            : Object.assign({}, v);\r\n\r\n        setValue(newValue as U);\r\n        if(!v){\r\n            console.log('target=', target)\r\n            console.log('propertyChain=', propertyChain)\r\n            console.log('defaultValue=', defaultValue)\r\n            console.log('conf=', conf)\r\n            console.trace('v is null')\r\n            return;\r\n        }\r\n        return watchUpdates(v, (info) => {\r\n            logger.log('watchUpdates_fn', 'info=', info)\r\n            // setValue((_.isArray(v) ? [...v ] : {...v}) as U)\r\n            // 使用 Object.assign 来避免循环引用\r\n            const newValue = _.isArray(v)\r\n                ? [...v]\r\n                : Object.assign({}, v);\r\n\r\n            setValue(newValue as U);\r\n        }, conf)\r\n    }, [v])\r\n    return [value, v]\r\n}\r\n\r\n","import { Box, Button, Container } from '@mui/material';\r\nimport { createContext, PropsWithChildren, useContext, useEffect } from 'react';\r\nimport { ITitleI18nConf, ITitleI18nNsConf, ITitleI18nTitleConf } from '.';\r\nimport { isBuild, isDev, isServer, loadI18nValue, publicRuntimeConfig } from '@fanfanlo';\r\nimport { read } from 'fs';\r\nimport { useTranslation } from '@fanfanlo';\r\n\r\n\r\nfunction Reload(){\r\n  if(!isDev)return <>  </>\r\n  const {t} = useTranslation(\"app-ui/components/page/content\")\r\n  return(\r\n    <Box>\r\n      <Button onClick={() => {window.location.reload()}}>{t(\"PageContent.refresh\")}</Button>\r\n      {new Date().toLocaleString()}\r\n    </Box>\r\n  )\r\n}\r\n\r\nconst ScrollP = createContext({ x: 0, y: 0 });\r\nlet index = 0;\r\nexport default function PageContent({ children, titleConf, reload }: {titleConf?:ITitleI18nConf, reload?: boolean} & PropsWithChildren) {\r\n  index++;\r\n  const scroll = useContext(ScrollP);\r\n  const clazz = `${Date.now() + Math.random() * Date.now()}`;\r\n  useEffect(()=>{\r\n    async function loadTitle(){\r\n      if(!titleConf)return\r\n      let title = titleConf.title\r\n      if(titleConf.ns){\r\n        title = await loadI18nValue(titleConf.ns, titleConf.key || \"content.title\")\r\n      }\r\n      if(!title)return\r\n      document.title = title\r\n    }\r\n    loadTitle()\r\n  }, [])\r\n  useEffect(() => {\r\n    const container = document.getElementsByClassName(clazz)[0];\r\n    if (!container) return;\r\n    container.scrollTop = scroll.y;\r\n    const onScroll = () => {\r\n      var scrollTop = container.scrollTop;\r\n      scroll.y = scrollTop;\r\n    };\r\n    container.removeEventListener('scroll', onScroll);\r\n    container.addEventListener('scroll', onScroll, { passive: true });\r\n    return () => container.removeEventListener('scroll', onScroll);\r\n  }, [clazz, scroll]);\r\n  return (\r\n\r\n    <Container className={clazz} sx={{ flexGrow: 1, overflow: 'auto', padding: \"0px\" }}>\r\n      <Box>\r\n        {(reload || (reload == undefined)) && <Reload />}\r\n        {children}\r\n      </Box>\r\n    </Container>\r\n  );\r\n}\r\n","import { PropsWithChildren } from \"react\";\r\nimport PageContent from \"./PageContent\";\r\nimport { ITitleI18nConf } from \".\";\r\nexport default function AndroidPageContent({ children, titleConf, reload }: {titleConf?:ITitleI18nConf, reload?: boolean} & PropsWithChildren)  {\r\n    return (\r\n        <PageContent titleConf={titleConf} reload={reload}>\r\n            {children}\r\n        </PageContent>\r\n    )\r\n}\r\n","'use client'\r\nimport { i18n, i18nInit, IPageScrollPosition, StorePageContext, StorePageDynamicContext, toProxy, watchUpdates, storeUtils } from \"@fanfanlo\";\r\nimport { useRouter } from \"next/router\";\r\nimport { PropsWithChildren, useEffect } from \"react\";\r\nimport { I18nextProvider } from \"react-i18next\";\r\n\r\n\r\ni18nInit()\r\n\r\nexport function AppShell({ children }: PropsWithChildren) {\r\n  const router = useRouter();\r\n  const scrollKey = 'scrollPositionInfo'\r\n  const href = window.location.href.split(\"#\")[0]\r\n  const dynamicKey = `dynamic-${href}`\r\n  const s = storeUtils.namespace(dynamicKey);\r\n  let o: Record<string, unknown>|undefined = s.read(dynamicKey)\r\n  if (!o) {\r\n    o = {}\r\n    s.write(dynamicKey, o)\r\n  }\r\n  o = toProxy(o)\r\n  useEffect(() => {\r\n\r\n    router.beforePopState((state) => {\r\n      s.clearAll()\r\n      return true\r\n    })\r\n  })\r\n  useEffect(() => {\r\n    s.write(dynamicKey, o)\r\n    return watchUpdates(o, () => {\r\n      s.write(dynamicKey, o)\r\n    })\r\n  }, [])\r\n  useEffect(() => {\r\n    const info = (s.read(scrollKey) || { x: 0, y: 0 }) as IPageScrollPosition\r\n    // console.log('app shell scroll info info = ', info)\r\n    if (info.x == 0 && info.y == 0) {\r\n      listenScroll()\r\n    } else {\r\n      window.requestAnimationFrame(() => {\r\n        window.scrollTo(info.x, info.y)\r\n        listenScroll()\r\n      })\r\n    }\r\n    function onScroll(e: Event) {\r\n      // console.log('app shell on scroll', { x: window.scrollX, y: window.scrollY })\r\n      s.write(scrollKey, { x: window.scrollX, y: window.scrollY })\r\n    }\r\n    function listenScroll() {\r\n      window.addEventListener('scroll', onScroll)\r\n    }\r\n\r\n    function unsub() {\r\n      window.removeEventListener('scroll', onScroll)\r\n    }\r\n    return unsub\r\n  });\r\n  return (\r\n    <StorePageContext value={s}>\r\n      <StorePageDynamicContext value={o}>\r\n\r\n        <I18nextProvider i18n={i18n}>\r\n          {children}\r\n        </I18nextProvider>\r\n      </StorePageDynamicContext>\r\n    </StorePageContext>\r\n  )\r\n}","import React, { useState } from 'react';\r\nimport { Dialog, DialogTitle, DialogContent, DialogActions, TextField, Button } from '@mui/material';\r\n\r\n/**\r\n * 会议创建弹窗\r\n * @param open 是否显示弹窗\r\n * @param onClose 关闭弹窗回调\r\n * @param onCreate 创建会议回调（传递表单数据）\r\n */\r\nexport function MeetingCreateDialog({ open, onClose, onCreate }: {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  onCreate: (data: { name: string }) => void;\r\n}) {\r\n  const [name, setName] = useState('');\r\n\r\n  function handleCreate() {\r\n    onCreate({ name });\r\n    setName('');\r\n  }\r\n\r\n  function handleClose() {\r\n    setName('');\r\n    onClose();\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onClose={handleClose} maxWidth=\"xs\" fullWidth>\r\n      <DialogTitle>创建会议</DialogTitle>\r\n      <DialogContent>\r\n        <TextField\r\n          label=\"会议名称\"\r\n          value={name}\r\n          onChange={e => setName(e.target.value)}\r\n          fullWidth\r\n          margin=\"normal\"\r\n        />\r\n      </DialogContent>\r\n      <DialogActions>\r\n        <Button onClick={handleClose}>取消</Button>\r\n        <Button onClick={handleCreate} variant=\"contained\" disabled={!name.trim()}>确定</Button>\r\n      </DialogActions>\r\n    </Dialog>\r\n  );\r\n} ","import { matrixClient } from '../client/client';\r\nimport type { IMeetingState } from './meetingState.types';\r\nimport { MATRIX_EVENT_TYPE_MEETING } from './meetingEvent.types';\r\n\r\n/**\r\n * 生成唯一 callId\r\n */\r\nfunction generateCallId() {\r\n  if (typeof crypto !== 'undefined' && crypto.randomUUID) {\r\n    return crypto.randomUUID();\r\n  }\r\n  // fallback\r\n  return Math.random().toString(36).slice(2) + Date.now();\r\n}\r\n\r\n/**\r\n * 发送会议开始事件（org.matrix.msc3401.call）\r\n * @param roomId 房间ID\r\n * @param options 会议参数（可选）\r\n */\r\nexport async function sendStartMeetingEvent(roomId: string, options?: Partial<Pick<IMeetingState, 'type'>>) {\r\n  const callId = generateCallId();\r\n  const userId = matrixClient.client.getUserId?.() || '';\r\n  const now = Date.now();\r\n  const content = {\r\n    state: 'started',\r\n    call_id: callId,\r\n    initiator: userId,\r\n    type: options?.type || 'normal',\r\n    started_at: now,\r\n  };\r\n  // @ts-ignore: 兼容自定义事件类型\r\n  await matrixClient.client.sendEvent(roomId, MATRIX_EVENT_TYPE_MEETING as any, content, '');\r\n  return callId;\r\n}\r\n\r\n/**\r\n * 发送会议结束事件（可选扩展）\r\n */\r\nexport async function sendEndMeetingEvent(roomId: string, callId: string) {\r\n  const userId = matrixClient.client.getUserId?.() || '';\r\n  const now = Date.now();\r\n  const content = {\r\n    state: 'ended',\r\n    call_id: callId,\r\n    initiator: userId,\r\n    ended_at: now,\r\n  };\r\n  // @ts-ignore: 兼容自定义事件类型\r\n  await matrixClient.client.sendEvent(roomId, MATRIX_EVENT_TYPE_MEETING as any, content, '');\r\n}\r\n\r\nexport const meetingEvent = {\r\n  sendStartMeetingEvent,\r\n  sendEndMeetingEvent,\r\n}; ","import React, { useState } from 'react';\r\nimport { IconButton, Menu, MenuItem } from '@mui/material';\r\nimport MoreVertIcon from '@mui/icons-material/MoreVert';\r\nimport { useRouter } from 'next/router';\r\nimport { useProxyWatch } from '@fanfanlo';\r\nimport { roomData } from '@src/im/client/room/data';\r\nimport { MeetingCreateDialog } from '../meeting/MeetingCreateDialog';\r\nimport { meetingEvent } from '@src/im/element-call/meetingEvent';\r\n\r\n/**\r\n * 创建会议菜单项按钮，内部自动判断会议状态和弹窗\r\n */\r\nfunction CreateMeetingMenuItem() {\r\n  const router = useRouter();\r\n  // roomId 可从路由参数获取\r\n  const roomId = typeof router.query.id === 'string' ? router.query.id : '';\r\n  // useProxyWatch 返回 [value, ...]，只取第一个值\r\n  const [disabled] = useProxyWatch(roomData.meetingStateMap, [roomId, 'meetingActive'], roomData.meetingStateMap[roomId]?.meetingActive || false);\r\n  const [dialogOpen, setDialogOpen] = useState(false);\r\n\r\n  function handleMenuClick() {\r\n    if (!disabled) setDialogOpen(true);\r\n  }\r\n  function handleDialogClose() {\r\n    setDialogOpen(false);\r\n  }\r\n  async function handleDialogSubmit(data: { name: string }) {\r\n    setDialogOpen(false);\r\n    if (!roomId) return;\r\n    // 真正发送会议事件\r\n    await meetingEvent.sendStartMeetingEvent(roomId, { type: 'normal' });\r\n    // 可选：toast.success('会议已创建')\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <MenuItem\r\n        onClick={handleMenuClick}\r\n        disabled={disabled}\r\n      >\r\n        创建会议\r\n      </MenuItem>\r\n      <MeetingCreateDialog\r\n        open={dialogOpen}\r\n        onClose={handleDialogClose}\r\n        onCreate={handleDialogSubmit}\r\n      />\r\n    </>\r\n  );\r\n}\r\n\r\n/**\r\n * 房间头部右上角更多操作按钮\r\n */\r\nexport function HeaderExtraButton() {\r\n  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);\r\n  const open = Boolean(anchorEl);\r\n\r\n  return (\r\n    <>\r\n      <IconButton\r\n        color=\"inherit\"\r\n        onClick={e => setAnchorEl(e.currentTarget)}\r\n        size=\"large\"\r\n      >\r\n        <MoreVertIcon />\r\n      </IconButton>\r\n      <Menu\r\n        anchorEl={anchorEl}\r\n        open={open}\r\n        onClose={() => setAnchorEl(null)}\r\n      >\r\n        <CreateMeetingMenuItem />\r\n        {/* 可扩展更多菜单项 */}\r\n      </Menu>\r\n    </>\r\n  );\r\n} ","import { AppBar, Toolbar, IconButton, Typography, Avatar, Box } from '@mui/material';\nimport MenuIcon from '@mui/icons-material/Menu';\nimport PeopleIcon from '@mui/icons-material/People';\nimport { useProxyWatchUpdates, useTranslation } from '@fanfanlo';\nimport { useProxyWatch } from '@fanfanlo';\nimport { matrixRoom } from '../../client/room';\nimport { useRouter } from 'next/router';\nimport KeyboardArrowLeft from '@mui/icons-material/KeyboardArrowLeft';\nimport { HeaderExtraButton } from './HeaderExtraButton';\n\nexport interface RoomHeaderProps {\n  roomId: string;\n  showMembers: boolean;\n  onToggleMembers: () => void;\n}\n\nexport function RoomHeader({ roomId, showMembers, onToggleMembers }: RoomHeaderProps) {\n  const { t } = useTranslation('homepage/im/components/room/content');\n  const router = useRouter();\n  const [roomInfo] = useProxyWatchUpdates(\n    matrixRoom.roomData.joinedRoomsMap,\n    [roomId],\n    matrixRoom.roomData.joinedRoomsMap[roomId] || {}\n  );\n  function onOpenSettingsClick(){\n    router.push(`/im/room/room-settings?id=${roomId}`);\n  }\n  function handleBack(){\n    router.back()\n  }\n  return (\n    <AppBar position=\"static\" color=\"default\" elevation={1}>\n      <Toolbar>\n        <KeyboardArrowLeft onClick={handleBack} />\n        <Box sx={{ mr: 2 }}>\n          <Avatar src={roomInfo?.avatarUrl}>\n            {roomInfo?.name?.charAt(0) || 'R'}\n          </Avatar>\n        </Box>\n        <Typography\n          variant=\"h6\"\n          component=\"div\"\n          sx={{\n            flexGrow: 1,\n            minWidth: 0,\n            overflow: 'hidden',\n            textOverflow: 'ellipsis',\n            whiteSpace: 'nowrap',\n            mr: 2,\n          }}\n        >\n          {roomInfo?.name || t('RoomHeader.unnamedRoom')}\n        </Typography>\n        <IconButton\n          color={showMembers ? 'primary' : 'default'}\n          onClick={onOpenSettingsClick}\n          title={t('RoomHeader.toggleMembers')}\n        >\n          <PeopleIcon />\n        </IconButton>\n        <HeaderExtraButton  />\n      </Toolbar>\n    </AppBar>\n  );\n}\n","import React from 'react';\nimport { ITextMessage } from '../../../client/message/types';\nimport { Box, Typography } from '@mui/material';\n\ninterface TextMessageProps {\n  message: ITextMessage;\n  className?: string;\n}\n\nexport const TextMessage = ({ message, className = '' }: TextMessageProps) => {\n  return (\n    <Box className={`text-message ${className}`}>\n      <Typography variant=\"body1\">\n        {message.content.body}\n      </Typography>\n    </Box>\n  );\n}\n","import React from 'react';\nimport { ILocationMessage } from '../../../client/message/types';\nimport { Box, Typography, Button, Dialog, DialogTitle, DialogContent, DialogActions } from '@mui/material';\nimport { useTranslation } from '@fanfanlo';\n\n\ninterface LocationMessageProps {\n  message: ILocationMessage;\n  className?: string;\n}\n\nexport const LocationMessage = ({ message, className = '' }: LocationMessageProps) => {\n  const { t } = useTranslation('homepage/im/components/messages/location/content');\n  // 从 geo_uri 中解析经纬度\n  const geoUri = message.content.geo_uri;\n  const [_, coordinates] = geoUri.split(':');\n  const [latitude, longitude] = coordinates.split(',').map(Number);\n  \n  // 构建静态地图 URL（使用百度地图）\n  const mapUrl = `https://api.map.baidu.com/staticimage/v2?ak=${process.env.REACT_APP_BAIDU_MAP_KEY || 'MmweUMZxcXOThZUaBuQ2rtKwLNHf1Hix'}&center=${longitude},${latitude}&zoom=12&width=300&height=200&markers=${longitude},${latitude}&markerStyles=m,B,0`;\n  \n  // 处理点击事件，打开交互式地图\n  const [open, setOpen] = React.useState(false);\n  const handleOpenMap = () => {\n    setOpen(true);\n  };\n\n  const handleClose = () => {\n    setOpen(false);\n  };\n  \n  return (\n    <Box className={`location-message ${className}`}>\n      <Box className=\"map-container\" mb={1}>\n        <img \n          src={mapUrl} \n          alt={message.content.info?.title || t('LocationMessage.title')} \n          onClick={handleOpenMap}\n          style={{ cursor: 'pointer' }}\n        />\n      </Box>\n      <Box display=\"flex\" justifyContent=\"space-between\" alignItems=\"center\">\n        <Typography variant=\"body2\" color=\"textSecondary\">\n          {message.content.info?.title || t('LocationMessage.title')}\n        </Typography>\n        <Button \n          variant=\"text\" \n          size=\"small\" \n          onClick={handleOpenMap}\n        >\n          {t('LocationMessage.viewMap')}\n        </Button>\n      </Box>\n      {open && (\n        <Dialog open={open} onClose={handleClose} maxWidth=\"sm\" fullWidth>\n          <DialogTitle>{message.content.info?.title || t('LocationMessage.title')}</DialogTitle>\n          <DialogContent>\n            <InteractiveLocationMap message={message} />\n          </DialogContent>\n          <DialogActions>\n            <Button onClick={handleClose} color=\"primary\">\n              {t('LocationMessage.close')}\n            </Button>\n          </DialogActions>\n        </Dialog>\n      )}\n    </Box>\n  );\n};\n\n// 在需要显示交互式地图的地方使用\nconst InteractiveLocationMap = React.forwardRef(({ message }: { message: ILocationMessage }, ref) => {\n  const [_, coordinates] = message.content.geo_uri.split(':');\n  const [latitude, longitude] = coordinates.split(',').map(Number);\n  \n  return (\n    <Box sx={{\n      width: '100%',\n      height: 400,\n      minHeight: 300,\n      position: 'relative'\n    }}>\n     \n    </Box>\n  );\n});\n\n","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface InviteMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const InviteMessage = ({ message, className = '' }: InviteMessageProps) => {\r\n  const inviter = message.sender;\r\n  const invitee = message.content.displayname || '';\r\n  const membership = message.content.membership;\r\n\r\n  if (membership === 'invite') {\r\n    return (\r\n      <div\r\n        className={`invite-message ${className}`}\r\n        style={{\r\n          color: '#fff',\r\n          background: '#1976d2',\r\n          borderRadius: 6,\r\n          padding: '8px 12px',\r\n          fontWeight: 500,\r\n          display: 'inline-block',\r\n          maxWidth: '100%',\r\n        }}\r\n      >\r\n        {inviter\r\n          ? `${inviter} 邀请了 ${invitee || '你'} 加入群聊`\r\n          : `你被邀请加入群聊`}\r\n      </div>\r\n    );\r\n  }\r\n  if (membership === 'join') {\r\n    return (\r\n      <div\r\n        className={`invite-message ${className}`}\r\n        style={{\r\n          color: '#fff',\r\n          background: '#388e3c',\r\n          borderRadius: 6,\r\n          padding: '8px 12px',\r\n          fontWeight: 500,\r\n          display: 'inline-block',\r\n          maxWidth: '100%',\r\n        }}\r\n      >\r\n        {invitee\r\n          ? `${invitee} 已接受邀请加入群聊`\r\n          : `有成员已接受邀请加入群聊`}\r\n      </div>\r\n    );\r\n  }\r\n  // 兜底\r\n  return null;\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomNameMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomNameMessage = ({ message, className = '' }: RoomNameMessageProps) => {\r\n  const sender = message.sender;\r\n  const name = message.content.name;\r\n  return (\r\n    <div className={`room-name-message ${className}`} style={{ color: '#ffa000', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间名称为「${name}」` : `房间名称被修改为「${name}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomHistoryVisibilityMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nconst visibilityMap: Record<string, string> = {\r\n  shared: '所有成员可见',\r\n  invited: '仅被邀请成员可见',\r\n  joined: '仅加入后可见',\r\n  world_readable: '所有人可见',\r\n};\r\n\r\nexport const RoomHistoryVisibilityMessage = ({ message, className = '' }: RoomHistoryVisibilityMessageProps) => {\r\n  const sender = message.sender;\r\n  const visibility = message.content.history_visibility;\r\n  const text = visibilityMap[visibility] || visibility;\r\n  return (\r\n    <div className={`room-history-visibility-message ${className}`} style={{ color: '#8e24aa', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间历史可见性为「${text}」` : `房间历史可见性被修改为「${text}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomJoinRuleMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nconst joinRuleMap: Record<string, string> = {\r\n  invite: '仅邀请可加入',\r\n  public: '公开房间',\r\n  knock: '敲门加入',\r\n  restricted: '受限加入',\r\n};\r\n\r\nexport const RoomJoinRuleMessage = ({ message, className = '' }: RoomJoinRuleMessageProps) => {\r\n  const sender = message.sender;\r\n  const joinRule = message.content.join_rule;\r\n  const text = joinRuleMap[joinRule] || joinRule;\r\n  return (\r\n    <div\r\n      className={`room-join-rule-message ${className}`}\r\n      style={{\r\n        color: '#fff',\r\n        background: '#0288d1',\r\n        borderRadius: 6,\r\n        padding: '8px 12px',\r\n        fontWeight: 500,\r\n        display: 'inline-block',\r\n        maxWidth: '100%',\r\n      }}\r\n    >\r\n      {sender ? `${sender} 修改了房间加群规则为「${text}」` : `房间加群规则被修改为「${text}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomPowerLevelsMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomPowerLevelsMessage = ({ message, className = '' }: RoomPowerLevelsMessageProps) => {\r\n  const sender = message.sender;\r\n  return (\r\n    <div className={`room-power-levels-message ${className}`} style={{ color: '#c62828', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间权限设置` : `房间权限设置被修改`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomGuestAccessMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nconst guestAccessMap: Record<string, string> = {\r\n  can_join: '允许访客加入',\r\n  forbidden: '禁止访客加入',\r\n};\r\n\r\nexport const RoomGuestAccessMessage = ({ message, className = '' }: RoomGuestAccessMessageProps) => {\r\n  const sender = message.sender;\r\n  const guestAccess = message.content.guest_access;\r\n  const text = guestAccessMap[guestAccess] || guestAccess;\r\n  return (\r\n    <div className={`room-guest-access-message ${className}`} style={{ color: '#43a047', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了访客访问权限为「${text}」` : `访客访问权限被修改为「${text}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomTopicMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomTopicMessage = ({ message, className = '' }: RoomTopicMessageProps) => {\r\n  const sender = message.sender;\r\n  const topic = message.content.topic;\r\n  return (\r\n    <div className={`room-topic-message ${className}`} style={{ color: '#6d4c41', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间话题为「${topic}」` : `房间话题被修改为「${topic}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomCreateMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomCreateMessage = ({ message, className = '' }: RoomCreateMessageProps) => {\r\n  const sender = message.content.creator;\r\n  const version = message.content.room_version;\r\n  return (\r\n    <div\r\n      className={`room-create-message ${className}`}\r\n      style={{\r\n        color: '#fff',\r\n        background: '#1976d2',\r\n        borderRadius: 6,\r\n        padding: '8px 12px',\r\n        fontWeight: 500,\r\n        display: 'inline-block',\r\n        maxWidth: '100%',\r\n      }}\r\n    >\r\n      {sender ? `${sender} 创建了房间（版本 ${version}）` : `房间已创建（版本 ${version}）`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomAvatarMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomAvatarMessage = ({ message, className = '' }: RoomAvatarMessageProps) => {\r\n  const sender = message.sender;\r\n  return (\r\n    <div className={`room-avatar-message ${className}`} style={{ color: '#8e24aa', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间头像` : `房间头像已修改`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomCanonicalAliasMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomCanonicalAliasMessage = ({ message, className = '' }: RoomCanonicalAliasMessageProps) => {\r\n  const sender = message.sender;\r\n  const alias = message.content.canonical_alias;\r\n  return (\r\n    <div className={`room-canonical-alias-message ${className}`} style={{ color: '#0097a7', padding: '8px 0' }}>\r\n      {sender ? `${sender} 修改了房间主别名为「${alias}」` : `房间主别名被修改为「${alias}」`}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomTombstoneMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomTombstoneMessage = ({ message, className = '' }: RoomTombstoneMessageProps) => {\r\n  const replacement = message.content.replacement_room;\r\n  return (\r\n    <div className={`room-tombstone-message ${className}`} style={{ color: '#bdbdbd', padding: '8px 0' }}>\r\n      房间已废弃，迁移至 {replacement ? `「${replacement}」` : '新房间'}\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomEncryptionMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomEncryptionMessage = ({ message, className = '' }: RoomEncryptionMessageProps) => {\r\n  return (\r\n    <div className={`room-encryption-message ${className}`} style={{ color: '#388e3c', padding: '8px 0' }}>\r\n      已启用端到端加密\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\r\nimport { IMatrixMessage } from '../../../client/message/types';\r\n\r\ninterface RoomServerAclMessageProps {\r\n  message: IMatrixMessage;\r\n  className?: string;\r\n}\r\n\r\nexport const RoomServerAclMessage = ({ message, className = '' }: RoomServerAclMessageProps) => {\r\n  return (\r\n    <div className={`room-server-acl-message ${className}`} style={{ color: '#ffb300', padding: '8px 0' }}>\r\n      房间服务器访问控制已变更\r\n    </div>\r\n  );\r\n}; ","import React from 'react';\nimport { IMatrixMessage } from '../../client/message/types';\nimport { TextMessage } from './text/TextMessage';\nimport { LocationMessage } from './location/LocationMessage';\nimport { messageUtils } from '../../client/message/messageUtils';\nimport { InviteMessage } from './invite/InviteMessage';\nimport { RoomNameMessage } from './room/RoomNameMessage';\nimport { RoomHistoryVisibilityMessage } from './room/RoomHistoryVisibilityMessage';\nimport { RoomJoinRuleMessage } from './room/RoomJoinRuleMessage';\nimport { RoomPowerLevelsMessage } from './room/RoomPowerLevelsMessage';\nimport { RoomGuestAccessMessage } from './room/RoomGuestAccessMessage';\nimport { RoomTopicMessage } from './room/RoomTopicMessage';\nimport { RoomCreateMessage } from './room/RoomCreateMessage';\nimport { RoomAvatarMessage } from './room/RoomAvatarMessage';\nimport { RoomCanonicalAliasMessage } from './room/RoomCanonicalAliasMessage';\nimport { RoomTombstoneMessage } from './room/RoomTombstoneMessage';\nimport { RoomEncryptionMessage } from './room/RoomEncryptionMessage';\nimport { RoomServerAclMessage } from './room/RoomServerAclMessage';\n\ninterface MessageRendererProps {\n  message: IMatrixMessage;\n  className?: string;\n}\n\nexport const MessageRenderer = ({ \n  message, \n  className = '' \n}: MessageRendererProps) => {\n  const commonProps = {\n    message,\n    className\n  };\n\n  // 房间加群规则\n  if (message.content && message.content.join_rule) {\n    return <RoomJoinRuleMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间权限设置\n  if (message.content && (\n    message.content.events_default !== undefined ||\n    message.content.users !== undefined ||\n    message.content.ban !== undefined ||\n    message.content.kick !== undefined ||\n    message.content.redact !== undefined\n  )) {\n    return <RoomPowerLevelsMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 访客访问权限\n  if (message.content && message.content.guest_access) {\n    return <RoomGuestAccessMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间话题\n  if (message.content && message.content.topic) {\n    return <RoomTopicMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间历史可见性变更\n  if (message.content && message.content.history_visibility) {\n    return <RoomHistoryVisibilityMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间名称变更\n  if (message.content && message.content.name) {\n    return <RoomNameMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 邀请和接受邀请类型\n  if (message.content && (message.content.membership === 'invite' || message.content.membership === 'join')) {\n    return <InviteMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间创建\n  if (message.content && message.content.room_version && message.content.creator) {\n    return <RoomCreateMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间头像\n  if (message.content && message.content.avatar_url) {\n    return <RoomAvatarMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间主别名\n  if (message.content && message.content.canonical_alias) {\n    return <RoomCanonicalAliasMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 房间废弃/迁移\n  if (message.content && message.content.replacement_room) {\n    return <RoomTombstoneMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 启用加密\n  if (message.content && message.content.algorithm) {\n    return <RoomEncryptionMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  // 服务器访问控制\n  if (message.content && (message.content.allow || message.content.deny)) {\n    return <RoomServerAclMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  if (messageUtils.isTextMessage(message)) {\n    return <TextMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n\n  if (messageUtils.isLocationMessage(message)) {\n    return <LocationMessage key={message.event_id} {...commonProps} message={message} />;\n  }\n  \n  // 其他消息类型的处理...\n  console.log('unknown message=', message);\n  console.log('json message=', JSON.stringify(message));\n  return <div className={`unknown-message ${className}`}>\n    不支持的消息类型: {message.content.msgtype}\n  </div>;\n};\n","import { Box, Typography, Avatar } from '@mui/material';\r\nimport { MessageRenderer } from '../messages/MessageRenderer';\r\nimport { Log } from '@fanfanlo';\r\nimport { IMatrixMessage } from '@src/im/client';\r\nimport { roomData } from '@src/im/client/room/data';\r\nconst fileLogger = new Log(false, 'im.components.room.MessageItem');\r\n// fileLogger.childrenPaused = true;\r\n// fileLogger.pause = true;\r\ninterface MessageItemProps {\r\n  message: IMatrixMessage;\r\n  currentUserId: string;\r\n}\r\n\r\nexport function MessageItem({ message, currentUserId }: MessageItemProps) {\r\n  const logger = fileLogger.sub(false, 'MessageItem_ui');\r\n  logger.pause = true;\r\n  logger.log('message=', message);\r\n  logger.log('currentUserId=', currentUserId);\r\n\r\n  // 获取成员信息\r\n  let memberInfo = undefined;\r\n  if (message.room_id && message.sender !== currentUserId) {\r\n    const members = roomData.roomMembers[message.room_id] || [];\r\n    memberInfo = members.find(m => m.userId === message.sender);\r\n  }\r\n\r\n  const isSelf = message.sender === currentUserId;\r\n\r\n  if (isSelf) {\r\n    // 自己的消息，右对齐，无头像无昵称\r\n    return (\r\n      <Box\r\n        sx={{\r\n          display: 'flex',\r\n          justifyContent: 'flex-end',\r\n          pb: 2\r\n        }}\r\n      >\r\n        <Box\r\n          sx={{\r\n            maxWidth: '80%',\r\n            bgcolor: 'primary.main',\r\n            color: 'primary.contrastText',\r\n            p: 2,\r\n            borderRadius: 2,\r\n            boxShadow: 1,\r\n            position: 'relative',\r\n            wordBreak: 'break-word',\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n          }}\r\n        >\r\n          <MessageRenderer \r\n            message={message} \r\n            className={'sent-message'}\r\n          />\r\n          <Typography \r\n            variant=\"caption\" \r\n            sx={{ \r\n              display: 'block',\r\n              textAlign: 'right',\r\n              mt: 0.5,\r\n              opacity: 0.7,\r\n              color: 'primary.contrastText'\r\n            }}\r\n          >\r\n            {new Date(message.origin_server_ts).toLocaleTimeString()}\r\n          </Typography>\r\n        </Box>\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  // 别人的消息，左侧头像，右侧昵称+消息气泡纵向排列\r\n  return (\r\n    <Box\r\n      sx={{\r\n        display: 'flex',\r\n        justifyContent: 'flex-start',\r\n        alignItems: 'flex-start',\r\n        pb: 2\r\n      }}\r\n    >\r\n      <Avatar\r\n        src={memberInfo?.avatarUrl}\r\n        alt={memberInfo?.displayName || message.sender}\r\n        sx={{ width: 32, height: 32, mr: 1, mt: 0.5 }}\r\n      >\r\n        {(memberInfo?.displayName || message.sender)?.charAt(0) || '?'}\r\n      </Avatar>\r\n      <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start', maxWidth: '80%' }}>\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            fontSize: '0.75rem',\r\n            color: 'text.secondary',\r\n            maxWidth: 160,\r\n            textAlign: 'left',\r\n            overflow: 'hidden',\r\n            textOverflow: 'ellipsis',\r\n            whiteSpace: 'nowrap',\r\n            lineHeight: 1.2,\r\n            mb: 0.5,\r\n          }}\r\n          title={memberInfo?.displayName || message.sender}\r\n        >\r\n          {memberInfo?.displayName || message.sender}\r\n        </Typography>\r\n        <Box\r\n          sx={{\r\n            bgcolor: 'background.paper',\r\n            color: 'text.primary',\r\n            p: 2,\r\n            borderRadius: 2,\r\n            boxShadow: 1,\r\n            position: 'relative',\r\n            wordBreak: 'break-word',\r\n            maxWidth: '100%',\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n          }}\r\n        >\r\n          <MessageRenderer \r\n            message={message} \r\n            className={'received-message'}\r\n          />\r\n          <Typography \r\n            variant=\"caption\" \r\n            sx={{ \r\n              display: 'block',\r\n              textAlign: 'right',\r\n              mt: 0.5,\r\n              opacity: 0.7,\r\n              color: 'text.secondary'\r\n            }}\r\n          >\r\n            {new Date(message.origin_server_ts).toLocaleTimeString()}\r\n          </Typography>\r\n        </Box>\r\n      </Box>\r\n    </Box>\r\n  );\r\n}","import { Log, useProxyWatch, useProxyWatchUpdates, useTranslation } from '@fanfanlo';\r\nimport { Box, CircularProgress, Typography } from '@mui/material';\r\nimport { useEffect, useRef, useState, useLayoutEffect } from 'react';\r\nimport { IMatrixMessage, matrixRoom } from '../../client/room';\r\nimport { matrixUser } from '../../client/user';\r\nimport { MessageItem } from './MessageItem';\r\nconst fileLogger = new Log(false, 'im.components.room.MessageList')\r\n// fileLogger.childrenPaused = true;\r\n// fileLogger.pause = true;\r\ninterface MessageListProps {\r\n  roomId: string;\r\n}\r\n\r\nexport function MessageList({ roomId }: MessageListProps) {\r\n  const logger = fileLogger.sub(false, 'MessageList_ui');\r\n  logger.pause = true;\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n  const [autoScroll, setAutoScroll] = useState(true);\r\n  const wasAtBottomRef = useRef(true);\r\n  const userAtBottomRef = useRef(true);\r\n  const userReallyAtBottomRef = useRef(true);\r\n  const { t } = useTranslation('homepage/im/components/room/content');\r\n  const DISTANCE_TO_BOTTOM = 5; // px\r\n  const prevMessageCountRef = useRef(0);\r\n\r\n  // 判断是否接近底部\r\n  function isNearBottom(distance = DISTANCE_TO_BOTTOM) {\r\n    if (!messagesContainerRef.current) return false;\r\n    const { scrollTop, scrollHeight, clientHeight } = messagesContainerRef.current;\r\n    return scrollHeight - scrollTop - clientHeight <= distance;\r\n  }\r\n  \r\n  // 监听登录状态\r\n  const [loginResponse] = useProxyWatch(\r\n    matrixUser.userData,\r\n    'userInfo.loginResponse',\r\n    matrixUser.userData.userInfo.loginResponse\r\n  );\r\n  \r\n  // 监听消息列表\r\n  const [messageIds] = useProxyWatchUpdates(\r\n    matrixRoom.roomData.messages,\r\n    [`${roomId}`],\r\n    matrixRoom.roomData.messages[roomId] || []\r\n  );\r\n  const messagesMap = matrixRoom.roomData.messagesMap;\r\n  // 获取消息详情并转换为 IMatrixMessage 格式\r\n  const messageList = messageIds?.map(id => {\r\n    const message = messagesMap[id];\r\n    if (!message) {\r\n      console.warn('Message not found:', id);\r\n      return null;\r\n    }\r\n    \r\n    // 转换为 IMatrixMessage 格式\r\n    const res:IMatrixMessage = {\r\n      event_id: message.event_id,\r\n      type: message.content.msgtype,\r\n      sender: message.sender,\r\n      origin_server_ts: message.origin_server_ts,\r\n      room_id: roomId,\r\n      content: message.content,\r\n    };\r\n    return res;\r\n  }).filter((item)=>{return item !== null}) || [];\r\n\r\n  // 滚动到底部\r\n  const scrollToBottom = () => {\r\n    console.log('[MessageList] scrollToBottom exec', {\r\n      messagesEndRef: messagesEndRef.current,\r\n      messagesContainerRef: messagesContainerRef.current,\r\n      scrollTop: messagesContainerRef.current?.scrollTop,\r\n      scrollHeight: messagesContainerRef.current?.scrollHeight,\r\n    });\r\n    if (messagesEndRef.current) {\r\n      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });\r\n    }\r\n  };\r\n\r\n  // 只在用户主动滚动时更新\"物理底部\"状态\r\n  const handleScroll = () => {\r\n    const atBottom = isNearBottom();\r\n    userReallyAtBottomRef.current = atBottom;\r\n    console.log('[MessageList] handleScroll, atBottom:', atBottom, 'autoScroll:', autoScroll);\r\n    setAutoScroll(atBottom);\r\n  };\r\n\r\n  // 新消息到来前，记录\"是否在底部\"\r\n  useLayoutEffect(() => {\r\n    wasAtBottomRef.current = userReallyAtBottomRef.current;\r\n    console.log('[MessageList] useLayoutEffect([messageList]), wasAtBottomRef.current:', wasAtBottomRef.current);\r\n  }, [messageList]);\r\n\r\n  // 渲染后，决定是否滚动到底\r\n  useEffect(() => {\r\n    console.log('[MessageList] useEffect([messageList, autoScroll]), wasAtBottomRef.current:', wasAtBottomRef.current, 'autoScroll:', autoScroll, 'messageList.length:', messageList.length);\r\n    if (wasAtBottomRef.current && autoScroll) {\r\n      setTimeout(() => {\r\n        scrollToBottom();\r\n      }, 0);\r\n    }\r\n  }, [messageList, autoScroll]);\r\n\r\n  // 首次加载消息时强制滚动到底部\r\n  useEffect(() => {\r\n    if (prevMessageCountRef.current === 0 && messageList.length > 0) {\r\n      setTimeout(() => {\r\n        scrollToBottom();\r\n      }, 0);\r\n    }\r\n    prevMessageCountRef.current = messageList.length;\r\n  }, [messageList]);\r\n\r\n  // 初始化时，autoScroll 设为 true\r\n  useEffect(() => {\r\n    setAutoScroll(true);\r\n  }, [roomId]);\r\n\r\n  return (\r\n    <Box id=\"messagesContainer\"\r\n      ref={messagesContainerRef}\r\n      onScroll={handleScroll}\r\n      sx={{\r\n        height: '100%',\r\n        flex: 1,\r\n        overflowY: 'auto',\r\n        p: 2,\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 2\r\n      }}\r\n    >\r\n      {!loginResponse?.user_id ? (\r\n        <Box display=\"flex\" justifyContent=\"center\" alignItems=\"center\" height=\"100%\">\r\n          <CircularProgress />\r\n        </Box>\r\n      ) : messageList.length === 0 ? (\r\n        <Box display=\"flex\" justifyContent=\"center\" alignItems=\"center\" height=\"100%\">\r\n          <Typography variant=\"body1\" color=\"text.secondary\">\r\n            {t('MessageList.noMessages')}\r\n          </Typography>\r\n        </Box>\r\n      ) : (\r\n        messageList.map((message) => (\r\n          <MessageItem \r\n            key={message.event_id}\r\n            message={message}\r\n            currentUserId={loginResponse.user_id}\r\n          />\r\n        ))\r\n      )}\r\n      <div ref={messagesEndRef} />\r\n    </Box>\r\n  );\r\n}\r\n","import { IMatrixMessage, ILocationMessage, ILocationContent } from '../types';\nimport { roomData } from '../../room/data';\nimport { Log } from '@fanfanlo';\nimport { matrixClient } from '../../client';\n\nconst logger = new Log(false, 'im.client.message.handlers.location');\n\n// 内部辅助函数\nfunction addToLocalCache(roomId: string, message: IMatrixMessage) {\n  roomData.messagesMap[message.id] = message;\n  \n  if (!roomData.messages[roomId]) {\n    roomData.messages[roomId] = [];\n  }\n  roomData.messages[roomId].push(message.id);\n}\n\nfunction updateMessageStatus(messageId: string, updates: Partial<IMatrixMessage>) {\n  const message = roomData.messagesMap[messageId];\n  if (message) {\n    roomData.messagesMap[messageId] = {\n      ...message,\n      ...updates\n    };\n  }\n}\n\n// 导出所有内容\nexport const locationMessageUtils = {\n  // 创建位置消息内容\n  createLocationContent: (\n    latitude: number,\n    longitude: number,\n    title: string = '',\n    description: string = ''\n  ): ILocationContent => ({\n    msgtype: 'm.location',\n    body: title || `位置: ${latitude}, ${longitude}`,\n    geo_uri: `geo:${latitude},${longitude}`,\n    info: {\n      title,\n      description\n    }\n  }),\n\n  // 发送位置消息\n  send: async (\n    roomId: string,\n    latitude: number,\n    longitude: number,\n    title: string = '',\n    description: string = ''\n  ): Promise<string> => {\n    const content = locationMessageUtils.createLocationContent(latitude, longitude, title, description);\n    const tempId = `temp_${Date.now()}`;\n    \n    const message: ILocationMessage = {\n      id: tempId,\n      type: 'm.location',\n      sender: matrixClient.client?.getUserId() || '',\n      timestamp: Date.now(),\n      roomId,\n      content,\n      status: 'sending'\n    };\n\n    addToLocalCache(roomId, message);\n\n    if (!matrixClient.client) {\n      logger.error('Matrix client is not initialized');\n      throw new Error('Matrix client is not initialized');\n    }\n\n    try {\n      const eventId = await matrixClient.client.sendMessage(roomId, {\n        msgtype: 'm.location',\n        body: content.body,\n        geo_uri: content.geo_uri,\n        info: content.info\n      });\n\n      updateMessageStatus(tempId, {\n        id: eventId,\n        status: 'sent'\n      });\n\n      return eventId;\n    } catch (error) {\n      logger.error('Failed to send location message:', error);\n      updateMessageStatus(tempId, {\n        status: 'failed',\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n      throw error;\n    }\n  },\n\n  // 处理接收到的位置消息\n  handleReceived: (roomId: string, event: any): ILocationMessage => {\n    const message: ILocationMessage = {\n      id: event.event_id,\n      type: 'm.location',\n      sender: event.sender,\n      timestamp: event.origin_server_ts,\n      roomId,\n      content: {\n        msgtype: 'm.location',\n        body: event.content.body,\n        geo_uri: event.content.geo_uri,\n        info: event.content.info\n      },\n      status: 'received'\n    };\n\n    addToLocalCache(roomId, message);\n    return message;\n  }\n};","export enum MapProvider {\r\n  Baidu = 'baidu',\r\n  Google = 'google',\r\n  Amap = 'amap'\r\n}\r\n\r\n// 位置坐标类型\r\nexport interface Location {\r\n    lng: number;\r\n    lat: number;\r\n    accuracy?: number;\r\n    timestamp?: number;\r\n  }\r\n  \r\n  // 地图定位选项类型\r\n  export interface MapWatchOptions {\r\n    enableHighAccuracy?: boolean;\r\n    timeout?: number;\r\n    maximumAge?: number;\r\n  }\r\n  \r\n  // MapView 组件属性类型\r\n  export interface MapProps extends React.HTMLAttributes<HTMLDivElement> {\r\n    provider?: MapProvider;\r\n    center?: Location;\r\n    zoom?: number;\r\n    style?: React.CSSProperties;\r\n    onDeviceLocationUpdate?: (location: Location) => void;\r\n    onLocationError?: (error: any) => void;\r\n    watchPosition?: boolean;\r\n    watchOptions?: MapWatchOptions;\r\n    onCenterChange?: (location: Location) => void;\r\n  }","// MapView.tsx\nimport React, { useEffect, useRef, useState } from 'react';\nimport dynamic from 'next/dynamic';\nimport { Location, MapProps, MapWatchOptions, MapProvider } from './map.intf';\n\n\n// 默认配置\n// const defaultCenter = { lng: 116.402544, lat: 39.928216 };\n// const defaultZoom = 10;\n// const defaultWatchOptions = {\n//   enableHighAccuracy: true,\n//   timeout: 5000,\n//   maximumAge: 0\n// };\n\n// // 使用 dynamic 导入地图组件，并禁用 SSR\n// const MapWithLoader = dynamic<MapProps>(\n//   () => import('react-bmapgl').then((mod) => {\n//     const { Map, MapApiLoaderHOC } = mod;\n    \n//     // 创建一个函数式组件\n//     const MapComponent: React.FC<MapProps> = (props) => {\n//       const {\n//         center = defaultCenter,\n//         zoom = defaultZoom,\n//         onLocationUpdate,\n//         onLocationError,\n//         watchPosition = false,\n//         watchOptions = defaultWatchOptions,\n//         onCenterChange,\n//         ...restProps\n//       } = props;\n      \n//       const mapRef = useRef<any>(null);\n//       const geolocationRef = useRef<any>(null);\n//       const watchIdRef = useRef<number | null>(null);\n//       // 新增：本地中心点state\n//       const [currentCenter, setCurrentCenter] = useState<Location>(center);\n//       const [hasLocated, setHasLocated] = useState(false);\n\n//       // 只在初次定位后设置地图中心\n//       useEffect(() => {\n//         console.log('hasLocated=',hasLocated);\n//         console.log('navigator.geolocation=',navigator.geolocation);\n//         if (!hasLocated && navigator.geolocation) {\n//           navigator.geolocation.getCurrentPosition(\n//             (pos) => {\n//               const location = {\n//                 lng: pos.coords.longitude,\n//                 lat: pos.coords.latitude,\n//                 accuracy: pos.coords.accuracy,\n//                 timestamp: pos.timestamp || Date.now()\n//               };\n//               console.log('location=',location);\n//               setCurrentCenter(location);\n//               setHasLocated(true);\n//               onLocationUpdate?.(location);\n//             },\n//             (err) => {\n//               setHasLocated(true); // 不再尝试\n//               onLocationError?.(err);\n//             }\n//           );\n//         }\n//       }, [hasLocated, onLocationUpdate, onLocationError]);\n\n//       // 获取当前位置（仅watchPosition时回调，不再设置中心）\n//       const getCurrentPosition = () => {\n//         if (!geolocationRef.current) return;\n//         geolocationRef.current.getCurrentPosition(\n//           (position: any) => {\n//             if (position?.point) {\n//               const location = {\n//                 lng: position.point.lng,\n//                 lat: position.point.lat,\n//                 accuracy: position.accuracy,\n//                 timestamp: position.timestamp || Date.now()\n//               };\n//               onLocationUpdate?.(location);\n//             }\n//           },\n//           (error: any) => {\n//             onLocationError?.(error);\n//           },\n//           watchOptions\n//         );\n//       };\n\n//       // 监听位置变化（只回调，不设置中心）\n//       const startWatchingPosition = () => {\n//         if (!geolocationRef.current || !watchPosition) return;\n//         getCurrentPosition();\n//         watchIdRef.current = window.setInterval(() => {\n//           getCurrentPosition();\n//         }, watchOptions.timeout || 5000);\n//       };\n//       const stopWatchingPosition = () => {\n//         if (watchIdRef.current) {\n//           clearInterval(watchIdRef.current);\n//           watchIdRef.current = null;\n//         }\n//       };\n\n//       // 初始化地图和地理位置\n//       const initMap = (map: any) => {\n//         if (!map) return;\n//         mapRef.current = map;\n//         try {\n//           geolocationRef.current = new BMapGL.Geolocation();\n//           // 修正：获取真实地图实例\n//           const realMap = map.map || map.instance;\n//           if (realMap) {\n//             if (realMap.enableScrollWheelZoom) realMap.enableScrollWheelZoom(true);\n//             if (realMap.enableContinuousZoom) realMap.enableContinuousZoom();\n//             if (realMap.enableInertialDragging) realMap.enableInertialDragging();\n//           }\n//           if (onCenterChange) {\n//             (realMap || map).addEventListener('moveend', () => {\n//               const c = (realMap || map).getCenter();\n//               console.log('c=',c);\n//               onCenterChange({ lng: c.lng, lat: c.lat });\n//             });\n//           }\n//           if (watchPosition) {\n//             startWatchingPosition();\n//           }\n//         } catch (error) {\n//           onLocationError?.(error);\n//         }\n//       };\n\n//       useEffect(() => {\n//         return () => {\n//           stopWatchingPosition();\n//         };\n//       }, []);\n//       useEffect(() => {\n//         if (watchPosition) {\n//           startWatchingPosition();\n//         } else {\n//           stopWatchingPosition();\n//         }\n//         return () => {\n//           stopWatchingPosition();\n//         };\n//       }, [watchPosition]);\n\n//       return (\n//         <Map\n//           ref={initMap}\n//           style={{ height: '100%', width: '100%', ...restProps.style }}\n//           center={new BMapGL.Point(currentCenter.lng, currentCenter.lat)}\n//           zoom={zoom}\n//           {...restProps}\n//         />\n//       );\n//     };\n\n//     // 使用类型断言来避免类型错误\n//     return MapApiLoaderHOC({\n//       ak: 'MmweUMZxcXOThZUaBuQ2rtKwLNHf1Hix'\n//     })(MapComponent as any) as any;\n//   }), \n//   { \n//     ssr: false,\n//     loading: () => (\n//       <div style={{ \n//         height: '100%', \n//         width: '100%', \n//         display: 'flex', \n//         alignItems: 'center', \n//         justifyContent: 'center',\n//         backgroundColor: '#f5f5f5',\n//         color: '#666'\n//       }}>\n//         地图加载中...\n//       </div>\n//     )\n//   }\n// );\n\n// 动态导入各地图实现\nconst BaiduMapView = dynamic(() => import('./BaiduMapView').then(m => m.BaiduMapView), { ssr: false });\nconst GoogleMapView = dynamic(() => import('./GoogleMapView').then(m => m.GoogleMapView), { ssr: false });\nconst AmapMapView = dynamic(() => import('./AmapMapView').then(m => m.AmapMapView), { ssr: false });\n\nexport const MapView: React.FC<MapProps> = (props) => {\n  const { provider = MapProvider.Baidu, ...rest } = props;\n  if (provider === MapProvider.Google) {\n    return <GoogleMapView {...rest} />;\n  }\n  if (provider === MapProvider.Amap) {\n    return <AmapMapView {...rest} />;\n  }\n  return <BaiduMapView {...rest} />;\n};\n","import React, { useState, useCallback } from 'react';\nimport { \n  Dialog, \n  DialogTitle, \n  DialogContent, \n  DialogActions, \n  Button, \n  TextField,\n  Box,\n  CircularProgress,\n  Typography\n} from '@mui/material';\nimport { LocationOn as LocationIcon } from '@mui/icons-material';\nimport { useTranslation, MapView, MapProvider } from '@fanfanlo';\n\nexport interface LocationInfo {\n  latitude: number;\n  longitude: number;\n  title: string;\n  description: string;\n}\n\ninterface LocationPickerProps {\n  open: boolean;\n  onClose: () => void;\n  onConfirm: (location: LocationInfo) => void;\n  provider?: MapProvider;\n}\n\nexport const LocationPicker = ({ \n  open, \n  onClose, \n  onConfirm,\n  provider = MapProvider.Baidu\n}: LocationPickerProps) => {\n  const { t } = useTranslation('homepage/im/components/messages/location/content');\n  const [title, setTitle] = useState('');\n  const [description, setDescription] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [currentLocation, setCurrentLocation] = useState<{ lat: number; lng: number } | null>(null);\n  const [permissionDialogOpen, setPermissionDialogOpen] = useState(false);\n  const [permissionDeniedDialogOpen, setPermissionDeniedDialogOpen] = useState(false);\n\n  const handleGetCurrentLocation = useCallback(() => {\n    if (!navigator.geolocation) {\n      alert(t('LocationPicker.geolocationNotSupported'));\n      return;\n    }\n    console.log('Checking geolocation permissions...');\n    // 优先检测权限\n    if (navigator.permissions) {\n      navigator.permissions.query({ name: 'geolocation' }).then((result) => {\n        console.log('Permission state:', result.state);\n        if (result.state === 'granted') {\n          console.log('Permission granted, getting location...');\n          doGetLocation();\n        } else if (result.state === 'prompt') {\n          console.log('Permission prompt, showing dialog...');\n          setPermissionDialogOpen(true); // 确保这里被调用\n        } else if (result.state === 'denied') {\n          console.log('Permission denied, showing denied dialog...');\n          setPermissionDeniedDialogOpen(true);\n        }\n      }).catch((error) => {\n        console.error('Error checking permissions:', error);\n        // 兼容异常，直接尝试\n        doGetLocation();\n      });\n    } else {\n      console.log('Permissions API not supported, attempting to get location...');\n      // 兼容老浏览器\n      doGetLocation();\n    }\n  }, [t]);\n\n  const doGetLocation = () => {\n    setIsLoading(true);\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        setCurrentLocation({\n          lat: position.coords.latitude,\n          lng: position.coords.longitude\n        });\n        setIsLoading(false);\n      },\n      (error) => {\n        if (error.code === error.PERMISSION_DENIED) {\n          setPermissionDeniedDialogOpen(true);\n        } else if (error.code === error.POSITION_UNAVAILABLE) {\n          alert(t('LocationPicker.locationUnavailable'));\n        } else if (error.code === error.TIMEOUT) {\n          alert(t('LocationPicker.locationTimeout'));\n        } else {\n          alert(t('LocationPicker.getLocationFailed'));\n        }\n        setIsLoading(false);\n      },\n      {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 0\n      }\n    );\n  };\n\n  const handleSubmit = () => {\n    if (!currentLocation) return;\n    \n    onConfirm({\n      latitude: currentLocation.lat,\n      longitude: currentLocation.lng,\n      title: title || t('LocationPicker.myLocation'),\n      description\n    });\n    \n    // 重置表单\n    setTitle('');\n    setDescription('');\n    setCurrentLocation(null);\n    onClose();\n  };\n\n  return (\n    <>\n      <Dialog\n        open={open}\n        onClose={onClose}\n        maxWidth=\"sm\"\n        fullWidth\n        PaperProps={{\n          sx: {\n            minHeight: 600,\n            height: '100%'\n          }\n        }}\n      >\n        <DialogTitle>{t('LocationPicker.shareLocation')}</DialogTitle>\n        <DialogContent\n          sx={{\n            height: '100%',\n            display: 'flex',\n            flexDirection: 'column'\n          }}\n        >\n          <Box sx={{ width: '100%', height: '100%', mb: 3, position: 'relative' }}>\n          <MapView \n            style={{ height: '500px', width: '100%' }}\n            watchPosition={true}\n            provider={provider}\n            onDeviceLocationUpdate={(location) => {\n              // 设备物理位置变化\n              console.log('设备位置更新:', location);\n            }}\n            onCenterChange={(location) => {\n              // 地图中心变化\n              console.log('地图中心更新:', location);\n            }}\n            onLocationError={(error) => {\n              console.error('位置获取错误:', error);\n            }}\n          />\n          </Box>\n          <Box sx={{ mt: 2, mb: 3 }}>\n            <Button\n              variant=\"contained\"\n              startIcon={<LocationIcon />}\n              onClick={handleGetCurrentLocation}\n              disabled={isLoading}\n            >\n              {isLoading ? (\n                <CircularProgress size={24} />\n              ) : (\n                t('LocationPicker.getCurrentLocation')\n              )}\n            </Button>\n          </Box>\n\n          {currentLocation && (\n            <Box sx={{ mt: 2, mb: 3 }}>\n              <TextField\n                fullWidth\n                label={t('LocationPicker.title')}\n                value={title}\n                onChange={(e) => setTitle(e.target.value)}\n                margin=\"normal\"\n              />\n              <TextField\n                fullWidth\n                label={t('LocationPicker.description')}\n                value={description}\n                onChange={(e) => setDescription(e.target.value)}\n                margin=\"normal\"\n                placeholder={t('LocationPicker.descriptionPlaceholder')}\n              />\n              \n              <Box sx={{ mt: 2, p: 2, border: '1px solid #eee', borderRadius: 1 }}>\n                <Typography variant=\"subtitle2\" gutterBottom>\n                  {t('LocationPicker.preview')}\n                </Typography>\n                <Typography variant=\"body2\" color=\"text.secondary\">\n                  {t('LocationPicker.latitude')}: {currentLocation.lat.toFixed(6)}\n                  <br />\n                  {t('LocationPicker.longitude')}: {currentLocation.lng.toFixed(6)}\n                </Typography>\n              </Box>\n            </Box>\n          )}\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={onClose}>{t('LocationPicker.cancel')}</Button>\n          <Button \n            onClick={handleSubmit} \n            variant=\"contained\" \n            disabled={!currentLocation}\n          >\n            {t('LocationPicker.send')}\n          </Button>\n        </DialogActions>\n      </Dialog>\n      {/* 权限申请说明弹窗 */}\n      <Dialog open={permissionDialogOpen} onClose={() => setPermissionDialogOpen(false)}>\n        <DialogTitle>{t('LocationPicker.shareLocation')}</DialogTitle>\n        <DialogContent>\n          <Typography>{t('LocationPicker.permissionPrompt')}</Typography>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={() => setPermissionDialogOpen(false)}>{t('LocationPicker.cancel')}</Button>\n          <Button\n            onClick={() => {\n              setPermissionDialogOpen(false);\n              doGetLocation();\n            }}\n            variant=\"contained\"\n          >\n            {t('LocationPicker.getCurrentLocation')}\n          </Button>\n        </DialogActions>\n      </Dialog>\n      {/* 权限被拒绝弹窗 */}\n      <Dialog open={permissionDeniedDialogOpen} onClose={() => setPermissionDeniedDialogOpen(false)}>\n        <DialogTitle>{t('LocationPicker.shareLocation')}</DialogTitle>\n        <DialogContent>\n          <Typography color=\"error\">{t('LocationPicker.permissionDenied')}</Typography>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={() => setPermissionDeniedDialogOpen(false)}>{t('LocationPicker.cancel')}</Button>\n        </DialogActions>\n      </Dialog>\n    </>\n  );\n};\n","import { useState, useRef, KeyboardEvent } from 'react';\nimport { \n  Box, \n  TextField, \n  IconButton, \n  InputAdornment,\n  Tooltip\n} from '@mui/material';\nimport { \n  Send as SendIcon, \n  LocationOn as LocationIcon,\n  AttachFile as AttachFileIcon,\n  EmojiEmotions as EmojiIcon \n} from '@mui/icons-material';\nimport { useTranslation } from '@fanfanlo';\nimport { matrixClient } from '../../client';\nimport { locationMessageUtils } from '../../client/message/handlers/location';\nimport { LocationPicker } from '../messages/location/LocationPicker';\n\ninterface MessageInputProps {\n  roomId: string;\n}\n\nexport function MessageInput({ roomId }: MessageInputProps) {\n  const { t } = useTranslation('homepage/im/components/room/content');\n  const [message, setMessage] = useState('');\n  const [locationPickerOpen, setLocationPickerOpen] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  const sendMessage = async () => {\n    if (!message.trim()) return;\n    \n    try {\n      await matrixClient.client.sendTextMessage(roomId, message.trim());\n      setMessage('');\n      // 保持焦点在输入框\n      textareaRef.current?.focus();\n    } catch (error) {\n      console.error('发送消息失败:', error);\n    }\n  };\n\n  const handleLocationConfirm = async (location: { \n    latitude: number; \n    longitude: number; \n    title: string;\n    description: string;\n  }) => {\n    try {\n      await locationMessageUtils.send(\n        roomId,\n        location.latitude,\n        location.longitude,\n        location.title,\n        location.description\n      );\n    } catch (error) {\n      console.error('发送位置消息失败:', error);\n    }\n  };\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      // 处理文件上传\n      console.log('Selected file:', file);\n      // TODO: 实现文件上传逻辑\n    }\n  };\n\n  const handleKeyDown = (e: KeyboardEvent<HTMLDivElement>) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  return (\n    <Box sx={{ p: 2, borderTop: '1px solid', borderColor: 'divider' }}>\n      <Box sx={{ display: 'flex', alignItems: 'flex-end' }}>\n        <Tooltip title={t('MessageInput.attachFile')}>\n          <IconButton onClick={() => fileInputRef.current?.click()}>\n            <AttachFileIcon />\n            <input\n              type=\"file\"\n              ref={fileInputRef}\n              onChange={handleFileChange}\n              style={{ display: 'none' }}\n            />\n          </IconButton>\n        </Tooltip>\n        \n        <Tooltip title={t('MessageInput.emoji')}>\n          <IconButton>\n            <EmojiIcon />\n          </IconButton>\n        </Tooltip>\n        \n        <TextField\n          fullWidth\n          multiline\n          maxRows={4}\n          variant=\"outlined\"\n          placeholder={t('MessageInput.placeholder')}\n          value={message}\n          onChange={(e) => setMessage(e.target.value)}\n          onKeyDown={handleKeyDown}\n          inputRef={textareaRef}\n          sx={{ mx: 1 }}\n          InputProps={{\n            sx: { borderRadius: 4, pr: 1 },\n            endAdornment: (\n              <InputAdornment position=\"end\">\n                <Tooltip \n                  title={t('MessageInput.sendLocation')} \n                  disableFocusListener \n                  disableHoverListener\n                >\n                  <IconButton\n                    onClick={() => setLocationPickerOpen(true)}\n                    edge=\"end\"\n                    sx={{ mr: 0.5 }}\n                  >\n                    <LocationIcon color=\"primary\" />\n                  </IconButton>\n                </Tooltip>\n              </InputAdornment>\n            ),\n          }}\n        />\n        \n        <Tooltip \n          title={t('MessageInput.send')}\n        >\n          <span>\n            <IconButton \n              color=\"primary\" \n              onClick={sendMessage}\n              disabled={!message.trim()}\n              sx={{ alignSelf: 'flex-end', mb: 0.5 }}\n            >\n              <SendIcon />\n            </IconButton>\n          </span>\n        </Tooltip>\n      </Box>\n\n      <LocationPicker\n        open={locationPickerOpen}\n        onClose={() => setLocationPickerOpen(false)}\n        onConfirm={handleLocationConfirm}\n      />\n    </Box>\n  );\n}\n","import React, {\n  forwardRef,\n  useRef,\n  useState,\n  useCallback,\n  useEffect,\n  useImperativeHandle,\n  type ReactNode,\n  type CSSProperties,\n} from 'react';\nimport { Box, Fade, CircularProgress, Button, Badge } from '@mui/material';\nimport { useTranslation } from 'react-i18next';\n\ninterface ScrollInfo {\n  scrollTop: number;\n  scrollHeight: number;\n  clientHeight: number;\n  distanceFromBottom: number;\n  isAtTop: boolean;\n  isAtBottom: boolean;\n  timestamp: number;\n}\n\nexport interface MessageListScrollerRef {\n  scrollToBottom: (behavior?: ScrollBehavior) => void;\n  scrollToTop: (behavior?: ScrollBehavior) => void;\n  scrollToPosition: (position: number) => void;\n  getScrollPosition: () => number;\n  loadOlderMessages: () => Promise<void>;\n  loadNewerMessages: () => Promise<void>;\n}\n\nexport interface MessageListScrollerProps {\n  children: ReactNode;\n  onLoadMore?: () => Promise<void>;\n  onLoadNewer?: () => Promise<void>;\n  hasMore: boolean;\n  hasNewer: boolean;\n  loading: boolean;\n  loadingNewer: boolean;\n  className?: string;\n  style?: CSSProperties;\n  roomId: string;\n}\n\nconst SCROLL_THRESHOLD = 100;\nconst SCROLL_DEBOUNCE_MS = 150;\n\ntype ScrollDirection = 'up' | 'down' | null;\n\nconst MessageListScroller = forwardRef<MessageListScrollerRef, MessageListScrollerProps>((\n  {\n    children,\n    onLoadMore = async () => {},\n    onLoadNewer = async () => {},\n    hasMore = false,\n    hasNewer = false,\n    loading = false,\n    loadingNewer = false,\n    className = '',\n    style = {},\n    roomId,\n  },\n  ref\n) => {\n  const { t } = useTranslation('homepage/im/components/room/content');\n  const listRef = useRef<HTMLDivElement>(null);\n  const debounceTimerRef = useRef<NodeJS.Timeout>();\n  const scrollTimeoutRef = useRef<NodeJS.Timeout>();\n  const isAtBottomRef = useRef(true);\n  const scrollDirectionRef = useRef<ScrollDirection>(null);\n  // 使用对象存储滚动位置和时间戳，以便更好地控制滚动行为\n  const lastScrollTopRef = useRef<{ scrollTop: number; time?: number }>({ scrollTop: 0 });\n  const isLoadingOlderRef = useRef(false);\n  const isLoadingNewerRef = useRef(false);\n  const isInitialLoadRef = useRef(true);\n  const isProgrammaticScrollRef = useRef(false);\n  const scrollAnimationFrameRef = useRef<number>();\n\n  const [showScrollToBottom, setShowScrollToBottom] = useState(false);\n  const [newMessageCount, setNewMessageCount] = useState(0);\n\n  // 更新滚动信息\n  const updateScrollInfo = useCallback((el: HTMLDivElement): ScrollInfo | null => {\n    if (!el) return null;\n    \n    const { scrollTop, scrollHeight, clientHeight } = el;\n    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;\n    // 调整顶部检测阈值，确保更容易触发加载\n    const isAtTop = scrollTop <= SCROLL_THRESHOLD * 1.5;\n    const isAtBottom = distanceFromBottom <= SCROLL_THRESHOLD;\n    \n    // 更新滚动方向（仅当滚动位置变化超过阈值时）\n    const SCROLL_THRESHOLD_PX = 1; // 1px threshold to reduce noise\n    const scrollDiff = scrollTop - lastScrollTopRef.current.scrollTop;\n    \n    if (Math.abs(scrollDiff) > SCROLL_THRESHOLD_PX) {\n      scrollDirectionRef.current = scrollDiff > 0 ? 'down' : 'up';\n      lastScrollTopRef.current = { ...lastScrollTopRef.current, scrollTop };\n      \n      console.log('Scroll direction updated:', {\n        direction: scrollDirectionRef.current,\n        scrollTop,\n        lastScrollTop: lastScrollTopRef.current.scrollTop,\n        diff: scrollDiff\n      });\n    }\n    \n    // 更新是否在底部的引用\n    isAtBottomRef.current = isAtBottom;\n    \n    return {\n      scrollTop,\n      scrollHeight,\n      clientHeight,\n      distanceFromBottom,\n      isAtTop,\n      isAtBottom,\n      timestamp: Date.now(),\n    };\n  }, []);\n\n  // 滚动到底部\n  const scrollToBottom = useCallback((behavior: ScrollBehavior = 'smooth') => {\n    const list = listRef.current;\n    if (!list) return;\n    \n    // 如果已经在底部，不需要滚动\n    const { scrollTop, scrollHeight, clientHeight } = list;\n    const isAtBottom = scrollHeight - (scrollTop + clientHeight) < 10;\n    if (isAtBottom) {\n      isAtBottomRef.current = true;\n      setShowScrollToBottom(false);\n      setNewMessageCount(0);\n      return;\n    }\n    \n    // 设置程序化滚动标志\n    isProgrammaticScrollRef.current = true;\n    \n    // 直接设置scrollTop而不是使用scrollTo可以避免触发scroll事件\n    list.scrollTop = list.scrollHeight;\n    \n    // 更新UI状态\n    isAtBottomRef.current = true;\n    setShowScrollToBottom(false);\n    setNewMessageCount(0);\n    \n    // 使用requestAnimationFrame确保DOM更新后重置标志\n    requestAnimationFrame(() => {\n      // 再次检查是否真的滚动到了底部\n      if (list) {\n        const { scrollTop, scrollHeight, clientHeight } = list;\n        isAtBottomRef.current = scrollHeight - (scrollTop + clientHeight) < 10;\n      }\n      // 延迟重置标志，防止滚动事件干扰\n      setTimeout(() => {\n        isProgrammaticScrollRef.current = false;\n      }, 100);\n    });\n  }, []);\n\n  // 滚动到顶部\n  const scrollToTop = useCallback((behavior: ScrollBehavior = 'smooth') => {\n    if (listRef.current) {\n      listRef.current.scrollTo({\n        top: 0,\n        behavior,\n      });\n    }\n  }, []);\n\n  // 滚动到指定位置\n  const scrollToPosition = useCallback((position: number) => {\n    if (listRef.current) {\n      listRef.current.scrollTop = position;\n    }\n  }, []);\n\n  // 获取滚动位置\n  const getScrollPosition = useCallback((): number => {\n    return listRef.current?.scrollTop || 0;\n  }, []);\n\n  // 加载更多历史消息\n  const loadOlderMessages = useCallback(async () => {\n    console.log('loadOlderMessages called');\n    if (!hasMore || loading || isLoadingOlderRef.current) {\n      console.log('Skipping loadOlderMessages:', { hasMore, loading, isLoadingOlder: isLoadingOlderRef.current });\n      return;\n    }\n    \n    console.log('Loading older messages...');\n    isLoadingOlderRef.current = true;\n    const list = listRef.current;\n    if (!list) {\n      console.log('No list element');\n      isLoadingOlderRef.current = false;\n      return;\n    }\n\n    // 保存当前滚动位置和内容高度\n    const scrollTop = list.scrollTop;\n    const scrollHeight = list.scrollHeight;\n    const isAtTop = scrollTop <= SCROLL_THRESHOLD;\n    const firstChild = list.firstElementChild as HTMLElement;\n    const firstChildOffset = firstChild ? firstChild.offsetTop : 0;\n    \n    console.log('Before load:', { scrollTop, scrollHeight, isAtTop, firstChildOffset });\n\n    try {\n      // 设置程序化滚动标志，防止滚动事件干扰\n      isProgrammaticScrollRef.current = true;\n      \n      // 加载更多消息\n      await onLoadMore();\n      \n      // 使用 requestAnimationFrame 确保 DOM 已更新\n      requestAnimationFrame(() => {\n        if (!list) return;\n        \n        const newScrollHeight = list.scrollHeight;\n        const heightDiff = newScrollHeight - scrollHeight;\n        console.log('After load:', { newScrollHeight, heightDiff });\n        \n        // 保持滚动位置\n        if (isAtTop && heightDiff > 0) {\n          console.log('Restoring scroll position:', { newPosition: heightDiff + scrollTop });\n          \n          // 方法1：使用新的滚动位置\n          list.scrollTop = heightDiff + scrollTop;\n          \n          // 方法2：使用第一个子元素的位置（备用）\n          if (firstChild) {\n            const newFirstChild = list.firstElementChild as HTMLElement;\n            if (newFirstChild) {\n              setTimeout(() => {\n                const newPosition = newFirstChild.offsetTop - firstChildOffset + scrollTop;\n                console.log('Alternative scroll position:', newPosition);\n                list.scrollTop = newPosition;\n              }, 0);\n            }\n          }\n        }\n        \n        // 重置程序化滚动标志\n        setTimeout(() => {\n          isProgrammaticScrollRef.current = false;\n        }, 100);\n      });\n    } catch (error) {\n      console.error('Failed to load older messages:', error);\n      isProgrammaticScrollRef.current = false;\n    } finally {\n      console.log('Finished loading older messages');\n      isLoadingOlderRef.current = false;\n    }\n  }, [hasMore, loading, onLoadMore]);\n\n  // 加载更新消息\n  const loadNewerMessages = useCallback(async () => {\n    console.log('loadNewerMessages called');\n    if (!hasNewer || loadingNewer || isLoadingNewerRef.current) return;\n    \n    isLoadingNewerRef.current = true;\n    const list = listRef.current;\n    if (!list) {\n      isLoadingNewerRef.current = false;\n      return;\n    }\n\n    const wasAtBottom = isAtBottomRef.current;\n\n    try {\n      await onLoadNewer();\n\n      // 检查是否仍然在底部\n      setTimeout(() => {\n        if (!list) return;\n        \n        const { scrollTop, scrollHeight, clientHeight } = list;\n        const isStillAtBottom = scrollHeight - (scrollTop + clientHeight) <= SCROLL_THRESHOLD;\n\n        if (wasAtBottom && isStillAtBottom) {\n          scrollToBottom('smooth');\n        } else if (!wasAtBottom) {\n          setNewMessageCount(prev => prev + 1);\n        }\n      }, 100);\n    } catch (error) {\n      console.error('Failed to load newer messages:', error);\n    } finally {\n      isLoadingNewerRef.current = false;\n    }\n  }, [hasNewer, loadingNewer, onLoadNewer, scrollToBottom]);\n\n  // 处理滚动事件\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\n    const el = e.currentTarget;\n    if (!el) return;\n\n    // 如果是程序化滚动，不处理滚动逻辑\n    if (isProgrammaticScrollRef.current) {\n      console.log('Programmatic scroll, skipping scroll handling');\n      return;\n    }\n\n    // 清除之前的防抖定时器\n    if (debounceTimerRef.current) {\n      clearTimeout(debounceTimerRef.current);\n    }\n\n    // 立即更新滚动位置\n    const currentScrollTop = el.scrollTop;\n    const currentTime = Date.now();\n    \n    // 更新滚动方向\n    const scrollDiff = currentScrollTop - lastScrollTopRef.current.scrollTop;\n    if (Math.abs(scrollDiff) > 1) { // 1px threshold\n      scrollDirectionRef.current = scrollDiff > 0 ? 'down' : 'up';\n    }\n    \n    // 更新滚动位置和时间戳\n    lastScrollTopRef.current = {\n      scrollTop: currentScrollTop,\n      time: currentTime\n    };\n    \n    console.log('Scroll event:', {\n      scrollTop: currentScrollTop,\n      direction: scrollDirectionRef.current,\n      isProgrammatic: isProgrammaticScrollRef.current\n    });\n\n    // 设置防抖处理\n    debounceTimerRef.current = setTimeout(() => {\n      const scrollInfo = updateScrollInfo(el);\n      if (!scrollInfo) return;\n\n      const { isAtTop, isAtBottom, scrollTop, scrollHeight, clientHeight } = scrollInfo;\n      \n      console.log('Scroll info:', { \n        isAtTop, \n        isAtBottom, \n        scrollTop, \n        scrollHeight, \n        clientHeight, \n        direction: scrollDirectionRef.current,\n        isProgrammatic: isProgrammaticScrollRef.current\n      });\n      \n      // 更新UI状态\n      setShowScrollToBottom(!isAtBottom);\n      isAtBottomRef.current = isAtBottom;\n\n      // 记录滚动状态\n      console.log('Scroll state:', {\n        isAtTop,\n        isAtBottom,\n        hasMore,\n        hasNewer,\n        loading,\n        loadingNewer,\n        scrollDirection: scrollDirectionRef.current,\n        isProgrammatic: isProgrammaticScrollRef.current\n      });\n      \n      // 只在用户滚动时触发加载\n      if (!isProgrammaticScrollRef.current) {\n        // 滚动到顶部加载更多\n        if (isAtTop && hasMore && !loading && scrollDirectionRef.current === 'up') {\n          console.log('Loading older messages...');\n          loadOlderMessages().catch(error => {\n            console.error('Error loading older messages:', error);\n            // 确保加载状态被重置\n            isLoadingOlderRef.current = false;\n          });\n        }\n        // 滚动到底部加载更新\n        else if (isAtBottom && hasNewer && !loadingNewer && scrollDirectionRef.current === 'down') {\n          console.log('Loading newer messages...');\n          loadNewerMessages().catch(error => {\n            console.error('Error loading newer messages:', error);\n            // 确保加载状态被重置\n            isLoadingNewerRef.current = false;\n          });\n        }\n      }\n    }, SCROLL_DEBOUNCE_MS);\n  }, [hasMore, hasNewer, loading, loadingNewer, loadOlderMessages, loadNewerMessages, updateScrollInfo]);\n\n  // 初始滚动到底部\n  useEffect(() => {\n    if (isInitialLoadRef.current && listRef.current) {\n      isInitialLoadRef.current = false;\n      \n      console.log('Initial load, scrolling to bottom...');\n      \n      // 使用 setTimeout 确保所有子组件都已渲染\n      const timer = setTimeout(() => {\n        if (!listRef.current) return;\n        \n        const { scrollHeight, clientHeight, scrollTop } = listRef.current;\n        const isAtBottom = scrollHeight - (scrollTop + clientHeight) < 10;\n        \n        console.log('Initial scroll check:', { scrollHeight, clientHeight, scrollTop, isAtBottom });\n        \n        // 只有当不在底部时才滚动到底部\n        if (!isAtBottom) {\n          console.log('Scrolling to bottom...');\n          scrollToBottom('auto');\n        } else {\n          console.log('Already at bottom, no need to scroll');\n        }\n      }, 100);\n      \n      return () => {\n        clearTimeout(timer);\n      };\n    }\n  }, [scrollToBottom]);\n\n  // 清理定时器和动画帧\n  useEffect(() => {\n    return () => {\n      if (debounceTimerRef.current) clearTimeout(debounceTimerRef.current);\n      if (scrollTimeoutRef.current) clearTimeout(scrollTimeoutRef.current);\n      if (scrollAnimationFrameRef.current) {\n        cancelAnimationFrame(scrollAnimationFrameRef.current);\n      }\n    };\n  }, []);\n\n  // 暴露方法给父组件\n  useImperativeHandle(\n    ref,\n    () => ({\n      scrollToBottom,\n      scrollToTop,\n      scrollToPosition,\n      getScrollPosition,\n      loadOlderMessages,\n      loadNewerMessages,\n    }),\n    [scrollToBottom, scrollToTop, scrollToPosition, getScrollPosition, loadOlderMessages, loadNewerMessages]\n  );\n\n  return (\n    <Box\n      ref={listRef}\n      className={`message-list-scroller ${className}`}\n      style={{\n        position: 'relative',\n        height: '100%',\n        overflowY: 'auto',\n        ...style,\n      }}\n      onScroll={handleScroll}\n    >\n      {/* 顶部加载指示器 */}\n      <Box\n        sx={{\n          display: 'flex',\n          justifyContent: 'center',\n          padding: 1,\n          minHeight: 40,\n        }}\n      >\n        {loading && <CircularProgress size={20} />}\n      </Box>\n\n      {/* 消息列表内容 */}\n      {children}\n\n      {/* 底部加载指示器 */}\n      <Box\n        sx={{\n          display: 'flex',\n          justifyContent: 'center',\n          padding: 1,\n          minHeight: 40,\n        }}\n      >\n        {loadingNewer && <CircularProgress size={20} />}\n      </Box>\n\n      {/* 滚动到底部按钮 */}\n      <Fade in={showScrollToBottom}>\n        <Box\n          sx={{\n            position: 'sticky',\n            bottom: 16,\n            left: '50%',\n            transform: 'translateX(-50%)',\n            zIndex: 1,\n          }}\n        >\n          <Button\n            variant=\"contained\"\n            color=\"primary\"\n            onClick={() => scrollToBottom('smooth')}\n            startIcon={\n              <Badge\n                badgeContent={newMessageCount}\n                color=\"error\"\n                invisible={newMessageCount === 0}\n              >\n                <Box width={24} height={24} />\n              </Badge>\n            }\n          >\n            {t('scrollToBottom')}\n          </Button>\n        </Box>\n      </Fade>\n    </Box>\n  );\n});\n\nMessageListScroller.displayName = 'MessageListScroller';\n\nexport { MessageListScroller };\nexport type { MessageListScrollerRef, MessageListScrollerProps };\n","import { Box, Paper, Divider, useTheme, CssBaseline } from '@mui/material';\nimport { useTranslation } from '@fanfanlo';\nimport { RoomHeader } from './RoomHeader';\nimport { MessageList } from './MessageList';\nimport { MessageInput } from './MessageInput';\nimport { RoomMembers } from './RoomMembers';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { useRouter } from 'next/router';\nimport { MessageListScroller, MessageListScrollerRef } from './MessageListScroller';\n\ninterface RoomContentProps {\n  roomId: string;\n}\n\nexport function RoomContent({ roomId }: RoomContentProps) {\n  const { t } = useTranslation('homepage/im/components/room/content');\n  const theme = useTheme();\n  const [showMembers, setShowMembers] = useState(false);\n\n  const router = useRouter();\n  const toggleMembers = () => {\n    setShowMembers(!showMembers);\n  };\n  const topBarRef = useRef<HTMLDivElement>(null);\n  const bottomBarRef = useRef<HTMLDivElement>(null);\n  const [bottomBarHeight, setBottomBarHeight] = useState(0);\n  const [topBarHeight, setTopBarHeight] = useState(0);\n  const [hasMoreMessages, setHasMoreMessages] = useState(true);\n  const [hasNewerMessages, setHasNewerMessages] = useState(true);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [isLoadingNewer, setIsLoadingNewer] = useState(false);\n  const messageScrollerRef = useRef<MessageListScrollerRef>(null);\n\n  useEffect(() => {\n    if (bottomBarRef.current) {\n      setBottomBarHeight(bottomBarRef.current.offsetHeight);\n    }\n  }, [bottomBarRef.current]);\n\n  useEffect(() => {\n    if (topBarRef.current) {\n      setTopBarHeight(topBarRef.current.offsetHeight);\n    }\n  }, [topBarRef.current]);\n  // 加载更多历史消息\n  const handleLoadMore = useCallback(async () => {\n    if (isLoadingMore || !hasMoreMessages) return;\n    \n    setIsLoadingMore(true);\n    try {\n      // TODO: 实现加载更多消息的逻辑\n      // 例如: await loadOlderMessages(roomId);\n      // 加载完成后更新 hasMoreMessages 状态\n      // setHasMoreMessages(/* 是否还有更多消息 */);\n      await new Promise(resolve => setTimeout(resolve, 1000)); // 模拟加载延迟\n    } finally {\n      setIsLoadingMore(false);\n    }\n  }, [roomId, isLoadingMore, hasMoreMessages]);\n\n  // 加载更新消息\n  const handleLoadNewer = useCallback(async () => {\n    if (isLoadingNewer || !hasNewerMessages) return;\n    \n    setIsLoadingNewer(true);\n    try {\n      // TODO: 实现加载更新消息的逻辑\n      // 例如: await loadNewerMessages(roomId);\n      // 加载完成后更新 hasNewerMessages 状态\n      // setHasNewerMessages(/* 是否还有更新消息 */);\n      await new Promise(resolve => setTimeout(resolve, 1000)); // 模拟加载延迟\n    } finally {\n      setIsLoadingNewer(false);\n    }\n  }, [roomId, isLoadingNewer, hasNewerMessages]);\n\n  // 滚动到底部\n  const scrollToBottom = useCallback(() => {\n    if (messageScrollerRef.current) {\n      messageScrollerRef.current.scrollToBottom();\n    }\n  }, []);\n\n  return (\n    <Box sx={{ display: 'flex', flexDirection: 'column', height: '100%' }}>\n      {/* 顶部 AppBar */}\n      <Box\n        ref={topBarRef}\n        sx={{\n          position: 'fixed',\n          top: 0,\n          left: 0,\n          right: 0,\n          backgroundColor: '#fff',\n          padding: '10px',\n          borderBottom: '1px solid #ccc',\n          zIndex: 1,\n        }}>\n        <RoomHeader roomId={roomId} onToggleMembers={toggleMembers} showMembers={showMembers} />\n      </Box>\n\n      {/* 中间内容区域 */}\n      <Box\n        sx={{\n          display: 'flex',\n          flexDirection: 'column',\n          height: `calc(100vh - ${topBarHeight + bottomBarHeight}px)`,\n          marginTop: `${topBarHeight}px`,\n          overflow: 'hidden',\n          backgroundColor: '#e0e0e0',\n        }}>\n        <Box\n          sx={{\n            flex: 1,\n            padding: 2,\n            height: '100%',\n            boxSizing: 'border-box',\n            position: 'relative',\n          }}>\n          <MessageListScroller \n            ref={messageScrollerRef}\n            roomId={roomId}\n            onLoadMore={handleLoadMore}\n            onLoadNewer={handleLoadNewer}\n            hasMore={hasMoreMessages}\n            hasNewer={hasNewerMessages}\n            loading={isLoadingMore}\n            loadingNewer={isLoadingNewer}\n          >\n            <MessageList roomId={roomId} onMessageSent={scrollToBottom} />\n          </MessageListScroller>\n        </Box>\n      </Box>\n\n      {/* 底部 BottomBar */}\n      <Box\n        ref={bottomBarRef}\n        sx={{\n          position: 'fixed',\n          bottom: 0,\n          left: 0,\n          right: 0,\n          backgroundColor: '#fff',\n          padding: '10px',\n          borderTop: '1px solid #ccc',\n          zIndex: 1,\n        }}>\n        <MessageInput roomId={roomId} />\n      </Box>\n    </Box>\n  );\n}\n","import { Box, Typography, Avatar, List, ListItem, ListItemAvatar, ListItemText, CircularProgress } from '@mui/material';\nimport { useProxyWatch, useProxyWatchUpdates, useTranslation } from '@fanfanlo';\nimport { matrixUser } from '../../client/user';\nimport { matrixRoom } from '../../client/room';\nimport { RoomMembership } from '../../client/room/types';\n\ninterface RoomMember {\n  userId: string;\n  displayName?: string;\n  avatarUrl?: string;\n  membership: RoomMembership;\n}\n\ninterface RoomMembersProps {\n  roomId: string;\n}\n\nexport function RoomMembers({ roomId }: RoomMembersProps) {\n  const { t } = useTranslation('homepage/im/components/room/content');\n  \n  // 监听登录状态\n  const [loginResponse] = useProxyWatch(\n    matrixUser.userData,\n    'userInfo.loginResponse',\n    matrixUser.userData.userInfo.loginResponse\n  );\n  \n  // 监听房间成员数据和加载状态\n  const [roomMembers] = useProxyWatchUpdates(\n    matrixRoom.roomData.roomMembers,\n    [`${roomId}`],\n    matrixRoom.roomData.roomMembers[roomId] || []\n  );\n  const [isFetchingMembers] = useProxyWatch(\n    matrixRoom.roomData.isFetchingMembers,\n    'value',\n    matrixRoom.roomData.isFetchingMembers.value\n  );\n\n  // 如果登录信息未加载完成，显示加载中\n  if (!loginResponse) {\n    return (\n      <Box sx={{ p: 2, textAlign: 'center' }}>\n        <CircularProgress size={24} />\n      </Box>\n    );\n  }\n\n  const currentUserId = loginResponse.user_id;\n  \n  // 将当前用户排在最前面\n  const sortedMembers = [...roomMembers].sort((a) => \n    a.userId === currentUserId ? -1 : 1\n  );\n\n  if (isFetchingMembers) {\n    return (\n      <Box sx={{ p: 2, textAlign: 'center' }}>\n        <CircularProgress size={24} />\n        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ mt: 1 }}>\n          {t('RoomMembers.loading')}\n        </Typography>\n      </Box>\n    );\n  }\n\n  if (sortedMembers.length === 0) {\n    return (\n      <Box sx={{ p: 2, textAlign: 'center' }}>\n        <Typography color=\"text.secondary\">\n          {t('RoomMembers.noMembers')}\n        </Typography>\n      </Box>\n    );\n  }\n\n  return (\n    <Box>\n      <List>\n        {sortedMembers.map((member: { userId: string; displayName?: string; avatarUrl?: string; membership: 'join' | 'invite' | 'leave' | 'ban' }) => (\n          <ListItem key={member.userId}>\n            <ListItemAvatar>\n              <Avatar src={member.avatarUrl} alt={member.displayName || member.userId} />\n            </ListItemAvatar>\n            <ListItemText\n              primary={member.displayName || member.userId}\n              secondary={member.userId === currentUserId ? t('RoomMembers.you') : t(`RoomMembers.${member.membership}`)}\n            />\n          </ListItem>\n        ))}\n      </List>\n    </Box>\n  );\n}","export * from './RoomContent';\nexport * from './RoomHeader';\nexport * from './MessageList';\nexport * from './MessageInput';\nexport * from './RoomMembers';\nexport * from './types';\n","import { Direction } from 'matrix-js-sdk';\r\nimport { matrixClient } from '../../client';\r\nimport { messageUtils } from '../messageUtils';\r\nimport { IMatrixMessage } from '../../room/types';\r\n// 你需要根据实际项目引入 matrix 客户端实例\r\n// import { matrixClient } from '你的matrix客户端路径';\r\n\r\n\r\n/**\r\n * 基于 event_id 向前翻历史消息\r\n * @param client MatrixClient 实例\r\n * @param roomId 房间ID\r\n * @param eventId 作为锚点的消息ID\r\n * @param limit 拉取条数\r\n * @returns 拉取到的 MatrixEvent[]，以及是否到达最早\r\n */\r\nasync function loadHistoryByEventId(roomId: string, eventId: string, limit: number = 20) {\r\n    if(!matrixClient.client) return {\r\n        events: [],\r\n        isEnd: true,\r\n        timeline: null,\r\n    };\r\n  // 1. 获取 Room 实例\r\n  const room = await matrixClient.client.getRoom(roomId);\r\n  if (!room) {\r\n    throw new Error('Room not found: ' + roomId);\r\n  }\r\n\r\n  // 2. 获取 timelineSet\r\n  const timelineSet = await room.getUnfilteredTimelineSet();\r\n  if (!timelineSet) {\r\n    throw new Error('timelineSet not found for room: ' + roomId);\r\n  }\r\n\r\n  // 3. 获取包含该 event 的 timeline\r\n  const timeline = await matrixClient.client.getEventTimeline(timelineSet, eventId);\r\n  if (!timeline) {\r\n    throw new Error('timeline not found for event: ' + eventId);\r\n  }\r\n\r\n  // 4. 向前分页加载历史\r\n  const hasMore = await matrixClient.client.paginateEventTimeline(timeline, {\r\n    backwards: true,\r\n    limit,\r\n  });\r\n\r\n  // 5. 获取 timeline 上的所有事件\r\n  const events = await timeline.getEvents(); // Array<MatrixEvent>\r\n  \r\n  // 6. 提取 event 字段，转为 IMatrixMessage[]\r\n  const messages = events\r\n  .map(ev => ev.event)\r\n  .filter(\r\n    (ev): ev is {\r\n      event_id: string;\r\n      sender: string;\r\n      content: any;\r\n      origin_server_ts: number;\r\n      type: string;\r\n      unsigned?: any;\r\n      room_id?: string;\r\n    } =>\r\n      !!ev &&\r\n      typeof ev.event_id === 'string' &&\r\n      typeof ev.sender === 'string' &&\r\n      typeof ev.content === 'object' &&\r\n      ev.content !== undefined &&\r\n      typeof ev.origin_server_ts === 'number' &&\r\n      typeof ev.type === 'string'\r\n  )\r\n  .map(ev => ({\r\n    event_id: ev.event_id,\r\n    sender: ev.sender,\r\n    content: ev.content,\r\n    origin_server_ts: ev.origin_server_ts,\r\n    type: ev.type,\r\n    unsigned: ev.unsigned,\r\n    room_id: ev.room_id,\r\n  })) as IMatrixMessage[];\r\n  // 7. 批量写入本地消息池\r\n  messageUtils.batchAddHistoryMessages(roomId, messages);\r\n  // 6. 判断是否到达最早\r\n  const isEnd = !hasMore;\r\n\r\n  return {\r\n    events,\r\n    isEnd,\r\n    timeline,\r\n  };\r\n}\r\n\r\nexport const matrixLoadHistory = {\r\n  loadHistoryByEventId\r\n}","import React, { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { ListRange, Virtuoso } from 'react-virtuoso';\r\nimport { isDev, useTranslation } from '@fanfanlo';\r\nimport { MessageItem } from './MessageItem';\r\nimport { matrixRoom } from '../../client/room';\r\nimport { matrixUser } from '../../client/user';\r\nimport { useProxyWatch, useProxyWatchUpdates } from '@fanfanlo';\r\nimport { IMatrixMessage } from '@src/im/client';\r\nimport { matrixLoadHistory } from '@src/im/client/message/handlers/loadHistory';\r\nimport { Log } from '@fanfanlo';\r\n\r\ninterface MessageListVirtuosoProps {\r\n  roomId: string;\r\n}\r\n\r\nconst fileLogger = new Log(false, 'MessageListVirtuoso');\r\n// fileLogger.pause = true;\r\n// fileLogger.childrenPaused = true;\r\n\r\nexport function MessageListVirtuoso({ roomId }: MessageListVirtuosoProps) {\r\n  const logger = fileLogger.sub(false,'MessageListVirtuoso_ui');\r\n  logger.pause = true;\r\n  // logger.childrenPaused = true;\r\n\r\n  const { t } = useTranslation('homepage/im/components/room/content');\r\n\r\n  // 监听登录状态\r\n  const [loginResponse] = useProxyWatch(\r\n    matrixUser.userData,\r\n    'userInfo.loginResponse',\r\n    matrixUser.userData.userInfo.loginResponse\r\n  );\r\n\r\n  // 监听消息列表\r\n  const [messageIds] = useProxyWatchUpdates(\r\n    matrixRoom.roomData.messages,\r\n    [`${roomId}`],\r\n    matrixRoom.roomData.messages[roomId] || []\r\n  );\r\n  const messagesMap = matrixRoom.roomData.messagesMap;\r\n\r\n  // 获取消息详情并转换为 IMatrixMessage 格式\r\n  const messageList = (messageIds?.map(id => {\r\n    const message = messagesMap[id];\r\n    if (!message) return null;\r\n    return {\r\n      event_id: message.event_id,\r\n      type: message.content.msgtype,\r\n      sender: message.sender,\r\n      origin_server_ts: message.origin_server_ts,\r\n      room_id: roomId || '',\r\n      content: message.content,\r\n    };\r\n  }).filter((item): item is NonNullable<typeof item> => item !== null) || []) as IMatrixMessage[];\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [historyEnd, setHistoryEnd] = useState(false);\r\n  const [loadingHistory, setLoadingHistory] = useState(false);\r\n  const virtuosoRef = useRef<any>(null);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  // 补偿相关\r\n  const anchorMsgIdRef = useRef<string | null>(null); // 记录锚点消息id\r\n  const [autoCompensate, setAutoCompensate] = useState(false);\r\n\r\n  // 上拉加载更多历史消息，加载前记录 anchorMsgIdRef\r\n  const onLoadMore = useCallback(async () => {\r\n    logger.log('onLoadMore called', {\r\n      roomId,\r\n      messageListLen: messageList.length,\r\n      loading,\r\n      historyEnd,\r\n    });\r\n    if (!roomId || messageList.length === 0 || loading || historyEnd) return;\r\n    setLoading(true);\r\n    setLoadingHistory(true);\r\n    try {\r\n      anchorMsgIdRef.current = messageList[0]?.event_id;\r\n      const res = await matrixLoadHistory.loadHistoryByEventId(roomId, messageList[0].event_id, isDev ? 30 : 10);\r\n      logger.log('res=', res);\r\n      if (res.isEnd) setHistoryEnd(true);\r\n      setAutoCompensate(true); // 加载后触发补偿\r\n    } finally {\r\n      setLoading(false);\r\n      setLoadingHistory(false);\r\n    }\r\n  }, [roomId, messageList, loading, historyEnd]);\r\n\r\n  // 在 totalListHeightChanged 里做自动补偿\r\n  const handleTotalListHeightChanged = useCallback((height: number) => {\r\n    logger.log('[totalListHeightChanged] compensation check', { height, autoCompensate, anchorMsg: anchorMsgIdRef.current });\r\n    if (autoCompensate && anchorMsgIdRef.current) {\r\n      const newIndex = messageList.findIndex(msg => msg.event_id === anchorMsgIdRef.current);\r\n      logger.log('[autoCompensate] anchorMsgId', anchorMsgIdRef.current, 'newIndex', newIndex);\r\n      if (newIndex !== -1) {\r\n        setTimeout(() => {\r\n          logger.log('[autoScroll] scrollToIndex', { newIndex, anchorMsgId: anchorMsgIdRef.current });\r\n          virtuosoRef.current?.scrollToIndex({ index: newIndex, align: 'start', \r\n            // behavior: 'smooth' \r\n          });\r\n        }, 30);\r\n      }\r\n      setAutoCompensate(false);\r\n    }\r\n  }, [autoCompensate, messageList]);\r\n\r\n  // 监听用户主动操作，停止自动补偿\r\n  useEffect(() => {\r\n    const stopCompensate = () => {\r\n      logger.log('[userAction] stop autoCompensate');\r\n      setAutoCompensate(false);\r\n    };\r\n    const el = containerRef.current;\r\n    if (!el) return;\r\n    el.addEventListener('mousedown', stopCompensate);\r\n    el.addEventListener('touchstart', stopCompensate);\r\n    return () => {\r\n      el.removeEventListener('mousedown', stopCompensate);\r\n      el.removeEventListener('touchstart', stopCompensate);\r\n    };\r\n  }, []);\r\n\r\n  // 每次到顶都尝试加载历史\r\n  const handleAtTopStateChange = useCallback((atTop: boolean) => {\r\n    logger.log('[atTopStateChange]', { atTop, historyEnd, loading, loadingHistory });\r\n    if (atTop && !historyEnd && !loading && !loadingHistory) {\r\n      onLoadMore();\r\n    }\r\n  }, [historyEnd, loading, loadingHistory, onLoadMore]);\r\n\r\n  logger.log('messageList.length=', messageList.length);\r\n  return (\r\n    // <div ref={containerRef} style={{ height: '100%', width: '100%' }}>\r\n      <Virtuoso\r\n        ref={virtuosoRef}\r\n        totalListHeightChanged={handleTotalListHeightChanged}\r\n        style={{ height: '100%', width: '100%' }}\r\n        data={messageList}\r\n        itemContent={(index, message) => (\r\n          <MessageItem\r\n            message={message}\r\n            currentUserId={loginResponse?.user_id || ''}\r\n          />\r\n        )}\r\n        followOutput={\"auto\"}\r\n        atTopStateChange={handleAtTopStateChange}\r\n        components={{\r\n          EmptyPlaceholder: () => (\r\n            <div style={{ textAlign: 'center', color: '#888', padding: 16 }}>\r\n              {t('MessageList.noMessages')}\r\n            </div>\r\n          ),\r\n          Header: () =>\r\n            loading ? (\r\n              <div style={{ textAlign: 'center', color: '#888', padding: 8 }}>\r\n                {t('MessageList.loadingHistory')}\r\n              </div>\r\n            ) : historyEnd ? (\r\n              <div style={{ textAlign: 'center', color: '#888', padding: 8 }}>\r\n                {t('MessageList.historyEnd')}\r\n              </div>\r\n            ) : null,\r\n        }}\r\n      />\r\n    // </div>\r\n  );\r\n}\r\n\r\n","import React from 'react';\r\nimport { Box, Button, Typography } from '@mui/material';\r\nimport { useProxyWatch } from '@fanfanlo';\r\nimport { roomData } from '@src/im/client/room/data';\r\nimport { useTranslation } from '@fanfanlo';\r\nimport { useRouter } from 'next/router';\r\n\r\nexport function MeetingPanel({ roomId }: { roomId: string }) {\r\n  const [meetingActive] = useProxyWatch(roomData.meetingStateMap, [roomId, 'meetingActive'], false);\r\n  const [meetingId] = useProxyWatch(roomData.meetingStateMap, [roomId, 'meetingId'], undefined);\r\n  const { t } = useTranslation('homepage/im/components/meeting/content');\r\n  const router = useRouter();\r\n  if (!meetingActive) return null;\r\n  function handleJoinMeeting() {\r\n    if (!roomId || !meetingId) return;\r\n    router.push({\r\n      pathname: '/im/room/meeting',\r\n      query: { roomId, callId: meetingId }\r\n    });\r\n  }\r\n  return (\r\n    <Box\r\n      sx={{\r\n        width: '100%',\r\n        bgcolor: 'primary.light',\r\n        color: 'primary.contrastText',\r\n        p: 2,\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'space-between',\r\n        borderRadius: 1,\r\n        mb: 2,\r\n      }}\r\n    >\r\n      <Typography variant=\"body1\">{t('MeetingPanel.meetingOngoing')}</Typography>\r\n      <Button variant=\"contained\" color=\"primary\" onClick={handleJoinMeeting}>\r\n        {t('MeetingPanel.joinMeeting')}\r\n      </Button>\r\n    </Box>\r\n  );\r\n} ","import { Log, useTranslation } from '@fanfanlo';\r\nimport { Box, useTheme } from '@mui/material';\r\nimport { useRouter } from 'next/router';\r\nimport { useCallback, useEffect, useRef, useState } from 'react';\r\nimport { MessageInput } from './MessageInput';\r\nimport { MessageListVirtuoso } from './MessageListVirtuoso';\r\nimport { RoomHeader } from './RoomHeader';\r\nimport { MeetingPanel } from '../meeting/MeetingPanel';\r\n// import {MessageVirturalList} from './MessageVirturalList'\r\n\r\nconst fileLogger = new Log(false, 'im.components.room.RoomContent2');\r\n// fileLogger.pause = true;\r\n\r\ninterface RoomContent2Props {\r\n  roomId: string;\r\n}\r\n\r\nexport function RoomContent2({ roomId }: RoomContent2Props) {\r\n  const logger = fileLogger.sub(false, 'RoomContent2');\r\n  // logger.pause = true;\r\n  \r\n  const { t } = useTranslation('homepage/im/components/room/content');\r\n  const theme = useTheme();\r\n  const [showMembers, setShowMembers] = useState(false);\r\n  const router = useRouter();\r\n  \r\n  const topBarRef = useRef<HTMLDivElement>(null);\r\n  const bottomBarRef = useRef<HTMLDivElement>(null);\r\n  const [bottomBarHeight, setBottomBarHeight] = useState(0);\r\n  const [topBarHeight, setTopBarHeight] = useState(0);\r\n\r\n  useEffect(() => {\r\n    if (bottomBarRef.current) {\r\n      setBottomBarHeight(bottomBarRef.current.offsetHeight);\r\n    }\r\n  }, [bottomBarRef.current]);\r\n\r\n  useEffect(() => {\r\n    if (topBarRef.current) {\r\n      setTopBarHeight(topBarRef.current.offsetHeight);\r\n    }\r\n  }, [topBarRef.current]);\r\n\r\n  // 滚动到底部\r\n  const scrollToBottom = useCallback(() => {\r\n    // 由于移除了 MessageListScroller，这里暂时留空\r\n    // 后续可以实现自定义滚动逻辑\r\n  }, []);\r\n\r\n  // 切换成员面板\r\n  const toggleMembers = useCallback(() => {\r\n    setShowMembers(prev => !prev);\r\n  }, []);\r\n\r\n  return (\r\n    <Box sx={{ display: 'flex', flexDirection: 'column', height: '100%' }}>\r\n      {/* 顶部 AppBar */}\r\n      <Box\r\n        ref={topBarRef}\r\n        sx={{\r\n          position: 'fixed',\r\n          top: 0,\r\n          left: 0,\r\n          right: 0,\r\n          backgroundColor: '#fff',\r\n          padding: '10px',\r\n          borderBottom: '1px solid #ccc',\r\n          zIndex: 1,\r\n        }}>\r\n        <RoomHeader roomId={roomId} onToggleMembers={toggleMembers} showMembers={showMembers} />\r\n      </Box>\r\n\r\n      {/* 中间内容区域 */}\r\n      <Box\r\n        sx={{\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          height: `calc(100vh - ${topBarHeight + bottomBarHeight}px)`,\r\n          marginTop: `${topBarHeight}px`,\r\n          overflow: 'hidden',\r\n          backgroundColor: '#e0e0e0',\r\n        }}>\r\n        <Box\r\n          sx={{\r\n            flex: 1,\r\n            padding: 2,\r\n            height: '100%',\r\n            boxSizing: 'border-box',\r\n            position: 'relative',\r\n            overflowY: 'hidden',\r\n          }}>\r\n        <MeetingPanel roomId={roomId} />\r\n            <MessageListVirtuoso roomId={roomId} />\r\n            {/* <MessageListVirtuosoTest /> */}\r\n          {/* <MessageList roomId={roomId} /> */}\r\n          {/* <MessageVirturalList roomId={roomId} /> */}\r\n          {/* <VirtualListScrollToBottom /> */}\r\n        </Box>\r\n      </Box>\r\n\r\n      {/* 底部 BottomBar */}\r\n      <Box\r\n        ref={bottomBarRef}\r\n        sx={{\r\n          position: 'fixed',\r\n          bottom: 0,\r\n          left: 0,\r\n          right: 0,\r\n          backgroundColor: '#fff',\r\n          padding: '10px',\r\n          borderTop: '1px solid #ccc',\r\n          zIndex: 1,\r\n        }}>\r\n        <MessageInput roomId={roomId} />\r\n      </Box>\r\n    </Box>\r\n  );\r\n}","import { useRouter } from 'next/router';\r\nimport { useEffect } from 'react';\r\nimport { Dispatcher, useTranslation } from \"@fanfanlo\";\r\nimport { AppbarContainer, AppShell } from \"@app/ui\";\r\nimport { RoomContent } from '../../../im/components/room';\r\nimport { RoomContent2 } from '@src/im/components/room/RoomContent2';\r\n\r\nexport default function RoomPage() {\r\n  const { t } = useTranslation(\"homepage/pages/im/room/content\");\r\n  const router = useRouter();\r\n  const { id: roomId } = router.query;\r\n\r\n  useEffect(() => {\r\n    // 如果没有roomId，重定向到聊天列表\r\n    if (!roomId && router.isReady) {\r\n      router.push('/im');\r\n    }\r\n  }, [roomId, router]);\r\n\r\n  if (!roomId) {\r\n    return (\r\n      <AppShell>\r\n        <AppbarContainer appbarProps={{ title: t(\"content.title\"), back: true }} />\r\n      </AppShell>\r\n    );\r\n  }\r\n\r\n  // return(\r\n  //   <AppShell>\r\n  //     <RoomContentV2 roomId={roomId as string} dispatcher={new Dispatcher()} />\r\n  //   </AppShell>\r\n  // )\r\n  return (\r\n    \r\n    <RoomContent2 roomId={roomId as string} />\r\n  )\r\n\r\n  return (\r\n    <AppShell>\r\n      \r\n      {/* <AppbarContainer appbarProps={{ title: t(\"content.title\"), back: true }}> */}\r\n      <RoomContent roomId={roomId as string} />\r\n      {/* </AppbarContainer> */}\r\n    </AppShell>\r\n  );\r\n}","\n    (window.__NEXT_P = window.__NEXT_P || []).push([\n      \"/im/room\",\n      function () {\n        return require(\"private-next-pages/im/room/index.tsx\");\n      }\n    ]);\n    if(module.hot) {\n      module.hot.dispose(function () {\n        window.__NEXT_P.push([\"/im/room\"])\n      });\n    }\n  ","import { useEffect, useState } from 'react';\r\nimport { getProxyObject, PropertiesChain, proxyWatch, UnWatch } from '../watcher/proxyWatch';\r\nimport { Log } from '../log';\r\n\r\nlet count = 0;\r\n/**\r\n * 注意，如果target不是proxy对象，那么更改target的属性不会触发更新，这种情况可以使用返回的proxy对象。\r\n * @param target 监听的对象\r\n * @param propertyChain 监听的属性链\r\n * @param defaultValue 默认值\r\n * @returns [value, proxy, unsub] value: 监听的属性值, proxy: 监听的对象, unsub: 取消监听\r\n */\r\nexport function useProxyWatch<T extends object, U>(\r\n  target: T,\r\n  propertyChain: PropertiesChain<T>,\r\n  defaultValue: U,\r\n): [U, T, UnWatch] {\r\n  const logger = new Log(false, 'useProxyWatch_fn');\r\n  logger.pause = true;\r\n  if(!propertyChain){\r\n    console.error('propertyChain is undefined',defaultValue, target)\r\n  }\r\n  const [value, setValue] = useState(defaultValue);\r\n  const [proxy] = useState(getProxyObject(target).proxy);\r\n\r\n  let isFirstUpdate = true;\r\n  const onUpdate = (now: U, old?: U) => {\r\n    logger.log('onUpdate_fn=', 'propertyChain=', propertyChain, 'now=', now, 'old=', old);\r\n    if(!now){\r\n      if(isFirstUpdate){\r\n        now = defaultValue;\r\n      }\r\n    }\r\n    if(!now){\r\n      // console.trace(\"ggggggggggggggggggg223\", isFirstUpdate, defaultValue, propertyChain)\r\n    }\r\n    if(isFirstUpdate){\r\n      isFirstUpdate = false;\r\n    }\r\n    setValue(now);\r\n  };\r\n\r\n  const onUndefined = (info: any) => {\r\n    logger.log('onUndefined_fn=', 'propertyChain=', propertyChain, 'info=', info);\r\n    if (value === defaultValue) return;\r\n    if(!isFirstUpdate)return;\r\n    isFirstUpdate = false;\r\n    setValue(defaultValue);\r\n  };\r\n\r\n  let unwatch: UnWatch | null = null;\r\n  function unsub() {\r\n    unwatch?.();\r\n    unwatch = null;\r\n  }\r\n\r\n  useEffect(() => {\r\n    if(propertyChain){\r\n        unwatch = proxyWatch(target, propertyChain, onUpdate, onUndefined).unwatch;\r\n    }\r\n    return () => {\r\n      unwatch?.();\r\n    };\r\n  }, []);\r\n  return [value, proxy, unsub];\r\n}\r\n","import { Dispatcher } from \"@fanfanlo\"\r\nimport { DispatcherUnsubscribe } from \"@fanfanlo\"\r\n\r\nconst dipsatcher = new Dispatcher()\r\ninterface IStaticModel{\r\n    dipsatcher:Dispatcher\r\n    screenLockCount:number\r\n    switchPage:()=>void\r\n    listenSwitchPage:(callback:()=>void)=>DispatcherUnsubscribe \r\n}\r\nexport const staticModel:IStaticModel = {\r\n    dipsatcher,\r\n    screenLockCount:0,\r\n    switchPage:async()=>{\r\n        dipsatcher.dispatch(\"switchPage\")\r\n        staticModel.screenLockCount = 0\r\n    },\r\n    listenSwitchPage:(callback:()=>void)=>{\r\n        return dipsatcher.addListener(\"switchPage\",callback)\r\n    }\r\n}   \r\n","import { PropsWithChildren } from \"react\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport { useRouter } from \"next/router\";\r\n\r\n\r\nexport function PageTransition({ children }: PropsWithChildren) {\r\n    const router = useRouter()\r\n    return (\r\n\r\n        <AnimatePresence mode=\"sync\">\r\n            <motion.div\r\n                key={router.route}\r\n                initial={{ opacity: 0, y: 10 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                exit={{ opacity: 0, y: -110 }}\r\n                transition={{ duration: 0.3 }}\r\n            >\r\n                {children}\r\n            </motion.div>\r\n        </AnimatePresence>\r\n    )\r\n}","import { staticModel } from \"@app/static\";\r\nimport { Box } from \"@mui/material\";\r\nimport { useEffect } from \"react\";\r\nimport { PageTransition } from \"../motion\";\r\nlet idCount = 0\r\nexport function PageShell({children}:{children:React.ReactNode}){\r\n    const id = `app-shell-${idCount++}`\r\n    useEffect(()=>{\r\n        const box = document.querySelector(`#${id}`)\r\n        const unlisten = staticModel.listenSwitchPage(()=>{\r\n            if(!box)return\r\n        })\r\n        if(!box)return\r\n        box.addEventListener(\"click\",(e)=>{\r\n            if(staticModel.screenLockCount == 0)return\r\n            e.stopPropagation()\r\n            e.preventDefault()\r\n        })\r\n        return ()=>{\r\n            unlisten()\r\n        }\r\n    },[])\r\n    return (\r\n        <Box id={id}>\r\n            <PageTransition>\r\n                {children}  \r\n            </PageTransition>\r\n        </Box>\r\n    )\r\n}\r\n","import { AppBar, Box, Container, CssBaseline, Fab, Fade, Slide, Toolbar, Typography, useScrollTrigger } from \"@mui/material\";\r\nimport { PropsWithChildren, ReactNode } from \"react\";\r\n// import {AndroidPageContent} from \"../../\";\r\nimport { browserHistoryUtils, IDispatcher } from \"@fanfanlo\";\r\nimport KeyboardArrowLeft from '@mui/icons-material/KeyboardArrowLeft';\r\nimport KeyboardArrowUpIcon from '@mui/icons-material/KeyboardArrowUp';\r\nimport * as React from \"react\";\r\nimport { useRouter } from \"next/router\";\r\nimport { PageShell } from \"../app/PageShell\";\r\nimport shadows from \"@mui/material/styles/shadows\";\r\nimport AndroidPageContent from \"../page/AndroidPageContent\";\r\nimport { IAppBarBackAskEvent } from \"@app/static\";\r\nimport { ITitleI18nConf } from \"../page\";\r\ninterface Props {\r\n    /**\r\n     * Injected by the documentation to work in an iframe.\r\n     * You won't need it on your project.\r\n     */\r\n    window?: () => Window;\r\n    children?: React.ReactElement<unknown>;\r\n}\r\n\r\nfunction HideOnScroll(props: Props) {\r\n    const { children, window } = props;\r\n    // Note that you normally won't need to set the window ref as useScrollTrigger\r\n    // will default to window.\r\n    // This is only being set here because the demo is in an iframe.\r\n    const trigger = useScrollTrigger({\r\n        target: window ? window() : undefined,\r\n    });\r\n\r\n    return (\r\n        <Slide appear={false} direction=\"down\" in={!trigger}>\r\n            {children ?? <div />}\r\n        </Slide>\r\n    );\r\n}\r\nexport interface IAppbarProps extends PropsWithChildren {\r\n    title: ReactNode\r\n    back: boolean\r\n    backHandler?: () => boolean\r\n    backDispatcher?:IDispatcher\r\n    toolbar?:ReactNode\r\n    toolbarContent?:ReactNode\r\n}\r\nexport function Appbar({ title }: { title: ReactNode } & PropsWithChildren) {\r\n    return (\r\n\r\n        <AppBar color={\"inherit\"}>\r\n            <Toolbar>\r\n                <Typography variant=\"h6\" component=\"div\">\r\n                    {title}\r\n                </Typography>\r\n            </Toolbar>\r\n        </AppBar>\r\n    )\r\n}\r\n\r\ninterface IAppbarContainerProps extends PropsWithChildren {\r\n    appbarProps: IAppbarProps\r\n    titleConf?:ITitleI18nConf\r\n    reload?: boolean\r\n}\r\n\r\n// export interface IAppBarBackAskEvent{\r\n//     defaultPrevented:boolean\r\n// }\r\n\r\nfunction ScrollTop(props: Props) {\r\n    const { children, window } = props;\r\n    // Note that you normally won't need to set the window ref as useScrollTrigger\r\n    // will default to window.\r\n    // This is only being set here because the demo is in an iframe.\r\n    const trigger = useScrollTrigger({\r\n        target: window ? window() : undefined,\r\n        disableHysteresis: true,\r\n        threshold: 100,\r\n    });\r\n\r\n    const handleClick = (event: React.MouseEvent<HTMLDivElement>) => {\r\n        const anchor = (\r\n            (event.target as HTMLDivElement).ownerDocument || document\r\n        ).querySelector('#back-to-top-anchor');\r\n\r\n        if (anchor) {\r\n            anchor.scrollIntoView({\r\n                block: 'center',\r\n            });\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Fade in={trigger}>\r\n            <Box data-id=\"content-scroll-top-button\"\r\n                onClick={handleClick}\r\n                role=\"presentation\"\r\n                sx={{ position: 'fixed', bottom: 16, right: 16 }}\r\n            >\r\n                {children}\r\n            </Box>\r\n        </Fade>\r\n    );\r\n}\r\nexport function AppbarContainer(props: IAppbarContainerProps) {\r\n    const { children, appbarProps, titleConf, reload } = props;\r\n    const router = useRouter()\r\n    function handleBack(){\r\n        // 本想抽象成底层一个方法，但是考虑了一下router需要注入或者是一个callback，似乎像现在这样判断一下event也可以。回头继续观察一下吧。\r\n        const event = browserHistoryUtils.askHistoryBack()\r\n        if(event.defaultPrevented)return\r\n        if(appbarProps.backDispatcher){\r\n            const e:IAppBarBackAskEvent = {defaultPrevented:false}\r\n            appbarProps.backDispatcher.dispatch('back',e)\r\n            if(e.defaultPrevented)return\r\n        }\r\n        router.back()\r\n    }\r\n    return (\r\n        <PageShell>\r\n        <React.Fragment>\r\n            <CssBaseline />\r\n            <HideOnScroll {...props}>\r\n                <AppBar color=\"inherit\">\r\n                    {appbarProps.toolbar ? \r\n                    appbarProps.toolbar:\r\n                    <Toolbar>\r\n                        <KeyboardArrowLeft onClick={handleBack} />\r\n                        {appbarProps.title}\r\n                    </Toolbar>\r\n                    }\r\n                </AppBar>\r\n            </HideOnScroll>\r\n            <Toolbar id=\"back-to-top-anchor\" />\r\n            <Container sx={{padding:\"0\", marginTop:\"17px\"}}>\r\n                <AndroidPageContent titleConf={titleConf} reload={reload}>\r\n                    {children}\r\n                </AndroidPageContent>\r\n            </Container>\r\n\r\n            <ScrollTop {...props}>\r\n                <Fab size=\"small\" aria-label=\"scroll back to top\">\r\n                    <KeyboardArrowUpIcon />\r\n                </Fab>\r\n            </ScrollTop>\r\n        </React.Fragment>\r\n        </PageShell>\r\n    );\r\n}\r\n"],"names":["newValue","React","useState","Dialog","DialogTitle","DialogContent","DialogActions","TextField","Button","MeetingCreateDialog","open","onClose","onCreate","name","setName","handleCreate","handleClose","maxWidth","fullWidth","label","value","onChange","e","target","margin","onClick","variant","disabled","trim","matrixClient","MATRIX_EVENT_TYPE_MEETING","generateCallId","crypto","randomUUID","Math","random","toString","slice","Date","now","sendStartMeetingEvent","roomId","options","callId","userId","client","getUserId","content","state","call_id","initiator","type","started_at","sendEvent","sendEndMeetingEvent","ended_at","meetingEvent","IconButton","Menu","MenuItem","MoreVertIcon","useRouter","useProxyWatch","roomData","CreateMeetingMenuItem","router","query","id","meetingStateMap","meetingActive","dialogOpen","setDialogOpen","handleMenuClick","handleDialogClose","handleDialogSubmit","data","HeaderExtraButton","anchorEl","setAnchorEl","Boolean","color","currentTarget","size","AppBar","Toolbar","Typography","Avatar","Box","PeopleIcon","useProxyWatchUpdates","useTranslation","matrixRoom","KeyboardArrowLeft","RoomHeader","showMembers","onToggleMembers","roomInfo","t","joinedRoomsMap","onOpenSettingsClick","push","handleBack","back","position","elevation","sx","mr","src","avatarUrl","charAt","component","flexGrow","minWidth","overflow","textOverflow","whiteSpace","title","TextMessage","message","className","body","LocationMessage","geoUri","geo_uri","_","coordinates","split","latitude","longitude","map","Number","mapUrl","process","env","REACT_APP_BAIDU_MAP_KEY","setOpen","handleOpenMap","mb","img","alt","info","style","cursor","display","justifyContent","alignItems","InteractiveLocationMap","forwardRef","ref","width","height","minHeight","InviteMessage","inviter","sender","invitee","displayname","membership","div","background","borderRadius","padding","fontWeight","RoomNameMessage","visibilityMap","shared","invited","joined","world_readable","RoomHistoryVisibilityMessage","visibility","history_visibility","text","joinRuleMap","invite","public","knock","restricted","RoomJoinRuleMessage","joinRule","join_rule","RoomPowerLevelsMessage","guestAccessMap","can_join","forbidden","RoomGuestAccessMessage","guestAccess","guest_access","RoomTopicMessage","topic","RoomCreateMessage","creator","version","room_version","RoomAvatarMessage","RoomCanonicalAliasMessage","alias","canonical_alias","RoomTombstoneMessage","replacement","replacement_room","RoomEncryptionMessage","RoomServerAclMessage","messageUtils","MessageRenderer","commonProps","event_id","events_default","undefined","users","ban","kick","redact","avatar_url","algorithm","allow","deny","isTextMessage","isLocationMessage","console","log","JSON","stringify","msgtype","Log","fileLogger","MessageItem","currentUserId","memberInfo","logger","sub","pause","room_id","members","roomMembers","find","m","isSelf","pb","bgcolor","p","boxShadow","wordBreak","flexDirection","textAlign","mt","opacity","origin_server_ts","toLocaleTimeString","displayName","fontSize","lineHeight","CircularProgress","useEffect","useRef","useLayoutEffect","matrixUser","MessageList","messagesEndRef","messagesContainerRef","autoScroll","setAutoScroll","wasAtBottomRef","userAtBottomRef","userReallyAtBottomRef","DISTANCE_TO_BOTTOM","prevMessageCountRef","isNearBottom","distance","current","scrollTop","scrollHeight","clientHeight","loginResponse","userData","userInfo","messageIds","messages","messagesMap","messageList","warn","res","filter","item","scrollToBottom","scrollIntoView","behavior","handleScroll","atBottom","length","setTimeout","onScroll","flex","overflowY","gap","user_id","addToLocalCache","updateMessageStatus","messageId","updates","locationMessageUtils","createLocationContent","description","send","tempId","timestamp","status","error","Error","eventId","sendMessage","handleReceived","event","MapProvider","useCallback","LocationOn","LocationIcon","MapView","LocationPicker","onConfirm","provider","Baidu","setTitle","setDescription","isLoading","setIsLoading","currentLocation","setCurrentLocation","permissionDialogOpen","setPermissionDialogOpen","permissionDeniedDialogOpen","setPermissionDeniedDialogOpen","handleGetCurrentLocation","navigator","geolocation","alert","permissions","then","result","doGetLocation","catch","getCurrentPosition","lat","coords","lng","code","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","enableHighAccuracy","timeout","maximumAge","handleSubmit","PaperProps","watchPosition","onDeviceLocationUpdate","location","onCenterChange","onLocationError","startIcon","placeholder","border","gutterBottom","toFixed","br","InputAdornment","Tooltip","Send","SendIcon","AttachFile","AttachFileIcon","EmojiEmotions","EmojiIcon","MessageInput","setMessage","locationPickerOpen","setLocationPickerOpen","fileInputRef","textareaRef","sendTextMessage","focus","handleLocationConfirm","handleFileChange","file","files","handleKeyDown","key","shiftKey","preventDefault","borderTop","borderColor","click","input","multiline","maxRows","onKeyDown","inputRef","mx","InputProps","pr","endAdornment","disableFocusListener","disableHoverListener","edge","span","alignSelf","useImperativeHandle","Fade","Badge","SCROLL_THRESHOLD","SCROLL_DEBOUNCE_MS","MessageListScroller","children","onLoadMore","onLoadNewer","hasMore","hasNewer","loading","loadingNewer","listRef","debounceTimerRef","scrollTimeoutRef","isAtBottomRef","scrollDirectionRef","lastScrollTopRef","isLoadingOlderRef","isLoadingNewerRef","isInitialLoadRef","isProgrammaticScrollRef","scrollAnimationFrameRef","showScrollToBottom","setShowScrollToBottom","newMessageCount","setNewMessageCount","updateScrollInfo","el","distanceFromBottom","isAtTop","isAtBottom","SCROLL_THRESHOLD_PX","scrollDiff","abs","direction","lastScrollTop","diff","list","requestAnimationFrame","scrollToTop","scrollTo","top","scrollToPosition","getScrollPosition","loadOlderMessages","isLoadingOlder","firstChild","firstElementChild","firstChildOffset","offsetTop","newScrollHeight","heightDiff","newPosition","newFirstChild","loadNewerMessages","wasAtBottom","isStillAtBottom","prev","clearTimeout","currentScrollTop","currentTime","time","isProgrammatic","scrollInfo","scrollDirection","timer","cancelAnimationFrame","in","bottom","left","transform","zIndex","badgeContent","invisible","useTheme","RoomContent","theme","setShowMembers","toggleMembers","topBarRef","bottomBarRef","bottomBarHeight","setBottomBarHeight","topBarHeight","setTopBarHeight","hasMoreMessages","setHasMoreMessages","hasNewerMessages","setHasNewerMessages","isLoadingMore","setIsLoadingMore","isLoadingNewer","setIsLoadingNewer","messageScrollerRef","offsetHeight","handleLoadMore","Promise","resolve","handleLoadNewer","right","backgroundColor","borderBottom","marginTop","boxSizing","onMessageSent","List","ListItem","ListItemAvatar","ListItemText","RoomMembers","isFetchingMembers","sortedMembers","sort","a","member","primary","secondary","loadHistoryByEventId","limit","events","isEnd","timeline","room","getRoom","timelineSet","getUnfilteredTimelineSet","getEventTimeline","paginateEventTimeline","backwards","getEvents","ev","unsigned","batchAddHistoryMessages","matrixLoadHistory","Virtuoso","isDev","MessageListVirtuoso","setLoading","historyEnd","setHistoryEnd","loadingHistory","setLoadingHistory","virtuosoRef","containerRef","anchorMsgIdRef","autoCompensate","setAutoCompensate","messageListLen","handleTotalListHeightChanged","anchorMsg","newIndex","findIndex","msg","anchorMsgId","scrollToIndex","index","align","stopCompensate","addEventListener","removeEventListener","handleAtTopStateChange","atTop","totalListHeightChanged","itemContent","followOutput","atTopStateChange","components","EmptyPlaceholder","Header","MeetingPanel","meetingId","handleJoinMeeting","pathname","RoomContent2","AppbarContainer","AppShell","RoomPage","isReady","appbarProps"],"sourceRoot":"","ignoreList":[0]}